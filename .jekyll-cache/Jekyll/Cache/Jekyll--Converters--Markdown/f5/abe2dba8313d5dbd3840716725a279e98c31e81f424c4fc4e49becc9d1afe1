I"2<blockquote>
  <p>My .onion address: <a href="http://ryankozj554xw2ystipdnvpzrge22pkcogw2h5f4n24ztscir6v5d7id.onion/">http://ryankozj554xw2ystipdnvpzrge22pkcogw2h5f4n24ztscir6v5d7id.onion/</a></p>
</blockquote>

<p>The other day I thought about also running this website as a hidden service. Today I set all that up. It’ll admit that it’s not all that practical. I’m clearly not hiding who I am, nor am I trying to hide the IP address of my web server, but whatever. It does provide those with extreme privacy concerns the ability to avoid the clearnet while browsing my blog.</p>

<p>I have setup hidden services before but it had been a few years. This sounded like a fun project to help me recover from CTF burnout, and update my knowledge of hidden services.</p>

<h2 id="v3-onion-service">v3 Onion Service</h2>
<p>My site has been up and running for a while, and getting it running as a hidden service was fairly quick.</p>

<p>The first thing to do was add the respository for <a href="https://2019.www.torproject.org/docs/debian.html.en">Tor</a>.<br />
<code class="language-plaintext highlighter-rouge">sudo add-apt-repository 'deb https://deb.torproject.org/torproject.org bionic main'</code></p>

<p>Then add the gpg key used to sign the packages.</p>

<p><code class="language-plaintext highlighter-rouge">curl https://deb.torproject.org/torproject.org/A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89.asc | gpg --import</code></p>

<p><code class="language-plaintext highlighter-rouge">gpg --export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 | apt-key add -</code></p>

<p>Refresh sources and install <a href="https://www.torproject.org/">Tor</a>.</p>

<p><code class="language-plaintext highlighter-rouge">sudo apt-get update</code></p>

<p><code class="language-plaintext highlighter-rouge">sudo apt-get install tor deb.torproject.org-keyring</code></p>

<p>Create a directory for the hidden service.</p>

<p><code class="language-plaintext highlighter-rouge">mkdir /var/lib/tor/hidden_service</code></p>

<p>Set the ownership of the hidden service directory to <em>debian-tor</em>.</p>

<p><code class="language-plaintext highlighter-rouge">chown debian-tor:debian-tor /var/lib/tor/hidden_service/</code></p>

<p>Set the permissions of the hidden service directory.</p>

<p><code class="language-plaintext highlighter-rouge">chmod 0700 /var/lib/tor/hidden_service/</code></p>

<p>Modify the Tor configuration file to include our new hidden service.</p>

<p><code class="language-plaintext highlighter-rouge">vim /etc/tor/torrc</code></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>############### This section is just for location-hidden services ###

## Once you have configured a hidden service, you can look at the
## contents of the file ".../hidden_service/hostname" for the address
## to tell people.
##
## HiddenServicePort x y:z says to redirect requests on port x to the
## address y:z.

HiddenServiceDir /var/lib/tor/hidden_service/
HiddenServicePort 80 127.0.0.1:80
HiddenServicePort 443 127.0.0.1:443
</code></pre></div></div>

<p>Lastly, reload apache and tor.</p>

<p><code class="language-plaintext highlighter-rouge">sudo service tor reload &amp;&amp; sudo service apache2 reload</code></p>

<h2 id="onion-v3-vanity-address">Onion v3 Vanity Address</h2>

<h4 id="being-vain">Being Vain</h4>
<p>I’ve always though it was slick when <code class="language-plaintext highlighter-rouge">.onion</code> sites had a “vanity address”. All that means is that the first portion of their address is relevant to the site itself. Proton Mail uses <em>https://protonirockerxow.onion</em>, The New York Times uses <em>https://nytimes3xbfgragh.onion</em>, and who could forget the notorious Silk Road using <em>http://silkroadvb5piz3r.onion</em>.</p>

<p>According to the Tor Projects website,</p>
<blockquote>
  <p>Since Tor 0.3.2 and Tor Browser 7.5.a5 56-character long v3 onion addresses are supported and should be used instead.
<a href="https://gitweb.torproject.org/torspec.git/tree/rend-spec-v3.txt">Version 3 Specification</a>.</p>
</blockquote>

<p>This means that the vanity address isn’t going to look quite as cool as they did back in version 2. Since tor addresses are randomly generated, creating a vanity address requires the generation of tons and tons of keys. The more characters we’re looking for to match up in our address, the lower the probability we have of generating one. It’s exponentially more difficult to generate longer prefixes. Now that we have <code class="language-plaintext highlighter-rouge">56</code> characters instead of <code class="language-plaintext highlighter-rouge">16</code>, our vanity url will look mostly gibberish, instead of only half gibberish like we could get them to be in v2.</p>

<p>I still like them though, and in order to generate one on version 3 I used <a href="https://github.com/cathugger/mkp224o">mkp224o</a>. I really wanted the prefix <code class="language-plaintext highlighter-rouge">ryankozak</code>, but the best machine I had available to dedicate to the task was an old Intel i7-920 overclocked to 3.4GHz. Since I can’t run it for a crazy long time due to electricity being pretty expensive, I took what I could get. I just ran a quick calculation and generated the address <a href="http://ryankozj554xw2ystipdnvpzrge22pkcogw2h5f4n24ztscir6v5d7id.onion/">ryankozj554xw2ystipdnvpzrge22pkcogw2h5f4n24ztscir6v5d7id.onion/</a>. I put that to use by copying it into my hidden_service directory as such,</p>

<p><code class="language-plaintext highlighter-rouge">cp -R /home/ryan/mkp224o/onions/ryank4ei6f6243kczeyoatrthq4jhumubgtscshub3rttadwqzblw3qd.onion/* /var/lib/tor/hidden_service</code></p>

<p>Then I reloaded Tor once more, now the new onion domain is up and functional. I’ll update this post when with my new prefix, or next week when I give up.</p>

<p><a href="/wp-content/uploads/2019/06/onion_site.png.png"><img title="Onion Site" src="/wp-content/uploads/2019/06/onion_site.png" /></a></p>

<h3 id="reference">Reference</h3>
<ul>
  <li><a href="https://2019.www.torproject.org/docs/tor-doc-unix.html.en">https://2019.www.torproject.org/docs/tor-doc-unix.html.en</a></li>
  <li><a href="https://2019.www.torproject.org/docs/debian.html.en#ubuntu">https://2019.www.torproject.org/docs/debian.html.en#ubuntu</a></li>
  <li><a href="https://riseup.net/en/security/network-security/tor/onionservices-best-practices]">https://riseup.net/en/security/network-security/tor/onionservices-best-practices</a></li>
  <li><a href="https://www.jamieweb.net/blog/onionv3-vanity-address/">https://www.jamieweb.net/blog/onionv3-vanity-address/</a></li>
</ul>
:ET